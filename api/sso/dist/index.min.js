var we=Object.create;var Q=Object.defineProperty;var _e=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,ke=Object.prototype.hasOwnProperty;var Ee=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ye(e))!ke.call(s,n)&&n!==t&&Q(s,n,{get:()=>e[n],enumerable:!(r=_e(e,n))||r.enumerable});return s};var h=(s,e,t)=>(t=s!=null?we(be(s)):{},Ee(e||!s||!s.__esModule?Q(t,"default",{value:s,enumerable:!0}):t,s));var he=h(require("path")),j=require("process"),fe=h(require("@groupclaes/fastify-elastic")),ge=h(require("@groupclaes/fastify-authhandler")),me=h(require("./config"));var O=h(require("bcrypt")),ne=require("process"),$=h(require("./config"));var p=h(require("mssql")),A=h(require("jose"));var K=require("mssql"),J=require("./config"),T=new Map,d={get:async s=>{if(!T.has(s)){if(!J.mssql[s])throw new Error(`Configuration for pool '${s}' does not exist!`);let e=new K.ConnectionPool(J.mssql[s]),t=e.close.bind(e);e.close=(...r)=>(T.delete(s),t(...r)),T.set(s,await e.connect())}return T.get(s)},closeAll:()=>Promise.all(Array.from(T.values()).map(s=>s.then(e=>e.close())))};var b=h(require("./config"));var i=h(require("mssql"));var g="brabopak",q=class{constructor(){this.schema="[sso]"}async get(e){let t=new i.default.Request(await d.get(g));t.input("username",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getUser]`);if(r.recordset.length>0)return r.recordset[0]}async getUserInfo(e){let t=new i.default.Request(await d.get(g));t.input("user_id",i.default.Int,e);let r=await t.execute(`${this.schema}.[usp_getUserInfo]`);if(r.recordset.length>0)return r.recordset[0][0]}async updatePassword(e,t){let r=new i.default.Request(await d.get(g));r.input("user_id",i.default.Int,e),r.input("password",i.default.VarChar,t);let n=await r.execute(`${this.schema}.[usp_updateUserPassword]`);if(n.recordset.length>0)return n.rowsAffected[0]>0}async refreshTokenExists(e){let t=new i.default.Request(await d.get(g));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getTokenExists]`);if(r.recordset.length>0)return r.recordset[0].exists}async createAuthorizationCode(e,t,r){let n=new i.default.Request(await d.get(g));n.input("client_id",i.default.VarChar,e),n.input("user_id",i.default.Int,t),n.input("scope",i.default.VarChar,r);let o=await n.execute(`${this.schema}.[usp_createAuthorizationCode]`);if(o.recordset.length>0)return o.recordset[0].code}async getAuthorizationCode(e){let t=new i.default.Request(await d.get(g));t.input("code",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getAuthorizationCode]`);if(r.recordset.length>0)return r.recordset[0]}async createRefreshToken(e,t,r){let n=new i.default.Request(await d.get(g));n.input("user_id",i.default.Int,e),n.input("authorization_code",i.default.VarChar,t),n.input("access_token",i.default.VarChar,r);let o=await n.execute(`${this.schema}.[usp_createRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getRefreshToken(e){let t=new i.default.Request(await d.get(g));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getRefreshToken]`);if(r.recordset.length>0)return r.recordset[0]}async updateRefreshToken(e){let t=new i.default.Request(await d.get(g));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_updateRefreshToken]`);if(r.recordset)return r.recordset[0].token}async revokeRefreshToken(e,t,r){let n=new i.default.Request(await d.get(g));n.input("token",i.default.VarChar,e),n.input("reason_revoked",i.default.VarChar,t),n.input("replaced_by_token",i.default.VarChar,r);let o=await n.execute(`${this.schema}.[usp_revokeRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getMfaInfo(e){let t=new i.default.Request(await d.get(g));t.input("mfa_code",i.default.VarChar,e);let r=await t.execute(`${this.schema}[usp_getMfaInfo]`);if(r.recordset.length>0)return r.recordset[0]}async addAuthLog(e,t=!1,r=0,n=null,o="127.0.0.1",c=50,u=null){let a=new i.default.Request(await d.get(g));e===void 0&&(e=null),a.input("user_id",i.default.Int,e),a.input("client_id",i.default.VarChar,"hBK4c2uZK5"),a.input("success",i.default.Bit,t),a.input("result",i.default.TinyInt,r),a.input("reason",i.default.VarChar,n),a.input("ip",i.default.VarChar,o),a.input("rating",i.default.TinyInt,c),a.input("user_agent",i.default.VarChar,u);let l=await a.execute(`${this.schema}.[usp_addAuthLog]`);if(l.rowsAffected.length>0)return l.rowsAffected[0]>0}async getFailedAuthAttempts(e=null,t=null){let r=new i.default.Request(await d.get(g));r.input("user_id",i.default.Int,e),r.input("ip",i.default.VarChar,t);let n=await r.execute(`${this.schema}.[usp_getFailedAuthAttempts]`);return n.recordsets.length>0?{user:n.recordsets[0]??[],ip:n.recordsets[1]??[]}:{user:[],ip:[]}}};var Y=900,z="brabopak",_=class{constructor(){this.schema="[sso]";this.updatePassword=(e,t)=>this.sso.updatePassword(e,t);this.getAudSub=e=>({audience:[process.env.CLIENT_ID??"unknown"],subject:e.toString()});this.sso=new q}async getIdToken(e){let{audience:t,subject:r}=this.getAudSub(e.user_id),n=await this.sso.getUserInfo(e.user_id),o,c=e.scope.split(" ");for(let[a,l]of Object.entries(n))o||(o={}),c.indexOf(a)!==-1&&(o[a]=l);if(!o)throw new Error("Invalid payload");let u=await A.importJWK(b.default.key);return await new A.SignJWT(o).setProtectedHeader({alg:b.default.key.alg,kid:b.default.key.kid,jku:b.default.key.iss}).setIssuer(b.default.key.iss).setAudience(t).setExpirationTime(Y+"s").setSubject(r).sign(u)}async getAccessToken(e){let{audience:t,subject:r}=this.getAudSub(e.user_id),n=await A.importJWK(b.default.key);return await new A.SignJWT({}).setProtectedHeader({alg:b.default.key.alg,kid:b.default.key.kid,jku:b.default.key.iss}).setIssuer(b.default.key.iss).setAudience(t).setExpirationTime(Y+"s").setSubject(r).sign(n)}getRefreshToken(e,t,r){return this.sso.createRefreshToken(e,t,r)}async create(e,t,r){let n=new p.default.Request(await d.get(z));return n.input("username",p.default.VarChar,e),n.input("password",p.default.VarChar,t),n.input("usercode",p.default.Int,r),(await n.execute(`${this.schema}.[usp_createUser]`)).rowsAffected[0]>0}async checkSettings(e){let t=new p.default.Request(await d.get(z));return t.input("usercode",p.default.Int,e.usercode),t.input("user_type",p.default.Int,e.user_type),t.input("customer_id",p.default.Int,e.customer_id),t.input("address_id",p.default.Int,e.address_id),t.input("group_id",p.default.Int,e.group_id),t.input("promo",p.default.Bit,e.promo),t.input("bonus_percentage",p.default.Numeric,e.bonus_percentage),t.input("fostplus",p.default.Bit,e.fostplus),t.input("customer_type",p.default.VarChar,e.customer_type),t.input("price_class",p.default.Int,e.price_class),(await t.execute(`${this.schema}.[usp_createOrUpdateSettings]`)).rowsAffected[0]>0}async getCustomers(e){let t=new p.default.Request(await d.get(z));t.input("user_id",p.default.Int,e);let r=await t.execute(`${this.schema}.[usp_getCustomers]`);if(r.recordset.length>0)return r.recordset[0]}};var Z=h(require("https")),X=require("process");async function ee(s,e){return new Promise((t,r)=>{let n=Z.default.request(`https://www.google.com/recaptcha/api/siteverify?secret=${X.env.GOOGLE_API}&response=${s}`,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"}},o=>{let c="";o.on("data",u=>{c+=u}),o.on("end",u=>{let a=c&&typeof c=="string"?JSON.parse(c):c;if(c=null,!a){r("Could not verify reCAPTCHA!");return}e&&a.action!==e&&r("Actions do not match!"),a["error-codes"]&&a["error-codes"].length>0&&r(a["error-codes"]),t(a.success)}),o.on("error",u=>{r(u)})});n.on("error",o=>{r(o)}),n.end()})}var U=class{constructor(e,t){this._minLength=8;this._maxLength=128;this._requireLowercase=!1;this._requireUppercase=!1;this._requireDigits=!1;this._password=e,t&&(this._minLength=t.min_length||this._minLength,this._maxLength=t.max_length||this._maxLength,this._requireLowercase=t.require_digits||this._requireLowercase,this._requireUppercase=t.require_uppercase||this._requireUppercase,this._requireDigits=t.require_lowercase||this._requireDigits)}audit(){if(this._password.length<this._minLength)throw this.resolveError(P.E_MIN_LENGTH);if(this._password.length>this._maxLength)throw this.resolveError(P.E_MAX_LENGTH);if(this._requireDigits&&this._password.split("").some(e=>e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57))throw this.resolveError(P.E_REQUIRE_DIGITS);if(this._requireUppercase&&this._password.split("").some(e=>e.charCodeAt(0)>=65&&e.charCodeAt(0)<=90))throw this.resolveError(P.E_REQUIRE_UPPERCASE);if(this._requireLowercase&&this._password.split("").some(e=>e.charCodeAt(0)>=97&&e.charCodeAt(0)<=122))throw this.resolveError(P.E_REQUIRE_LOWECASE);return!0}resolveError(e){switch(e){case 0:return new E(e,`Password length must be at least ${this._minLength} characters long.`,{length:this._minLength});case 1:return new E(e,`Password length must be at most ${this._maxLength} characters long.`,{length:this._maxLength});case 2:return new E(e,"Password must contain at least one digit.");case 3:return new E(e,"Password must contain at least one uppercase character.");case 4:return new E(e,"Password must contain at least one lowercase character.")}return new Error("Unexpected error")}},P={E_MIN_LENGTH:0,E_MAX_LENGTH:1,E_REQUIRE_DIGITS:2,E_REQUIRE_UPPERCASE:3,E_REQUIRE_LOWECASE:4},E=class extends Error{constructor(t,r,n){super(r);this.error="PasswordPolicy";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var C=h(require("mssql")),re=h(require("nodemailer")),se=h(require("fs"));var te="brabopak",I=class{constructor(e,t,r){this._user=e,this._client_id=t,this._info=r}challengeRequired(){return!1}async challenge(e="nl"){if(!this._user.email)throw this.resolveError(F.E_CHALLENGE_NOT_SEND);let t=Ce(),r=new C.default.Request(await d.get(te));if(r.input("mfa_code",C.default.VarChar,t),r.input("user_id",C.default.Int,this._user.id),r.input("authorization_code",C.default.VarChar,this._info.authorization_code),(await r.query("INSERT INTO [sso].[mfaCodes] (code, userId, authorizationCode) VALUES (@mfa_code, @user_id, @authorization_code)")).rowsAffected[0]<=0)throw this.resolveError(F.E_CHALLENGE_NOT_SEND);let o=re.default.createTransport({host:"debian-smtp.groupclaes.be",port:25,secure:!1}),c=e==="nl"?"Meervoudige authenticatie":"Authentification multiple",u=se.default.readFileSync(`./templates/template_${e}.html`).toString("utf-8"),a='<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#ffffff" align="center" style="padding:30px 30px 40px"><table border="0" cellspacing="0" cellpadding="0"><tr><td align="center" style="border-radius:3px;" bgcolor="#40ab86"><span style="pointer-events:none;font-size:20px;font-family:Helvetica,Arial,sans-serif;color:#ffffff;text-decoration:none;color:#ffffff;text-decoration:none;padding:15px 25px;border-radius:2px;border:1px solid #24704C;display:inline-block;">@Button.Text</span></td></tr></table></td></tr></table>';u=u.replace("@RenderTitle()",c);let l="Geef onderstaande code in om toegang te krijgen tot de applicatie.";a=a.replace("@Button.Text",t);let m='Als je vragen hebt of om welke reden dan ook hulp nodig hebt, neem dan contact op met ons via <a href="mailto:it@groupclaes.be" style="color:#40ab86;text-decoration:underline;">it@groupclaes.be</a>.<br><br>Met vriendelijke groeten<br>Het ICT Team van Group Claes';u=u.replace("@RenderHeader()",c+" \u2714"),u=u.replace("@RenderBody()",l+a+m),await o.sendMail({from:'"Brabopak - webshop"<bestel@brabopak.com>',to:this._user.email,subject:c,text:c,html:u})}complete(e){if(e.length!==8)throw this.resolveError(F.E_INVALLID_CHALLENGE);if(this._info.code===e&&this._info.user_id===this._user.id)return!0;throw this.resolveError(F.E_CHALLENGE_FAILED)}async use(e){let t=new C.default.Request(await d.get(te));return t.input("mfa_code",C.default.VarChar,e),(await t.query("UPDATE [sso].[mfaCodes] SET used = CAST(1 AS BIT) WHERE code = @mfa_code")).rowsAffected[0]>0}resolveError(e){switch(e){case 0:return new R(e,"Failed to send challenge.");case 1:return new R(e,"Challenge already send.");case 2:return new R(e,"Challenge failed.");case 3:return new R(e,"Invallid challenge.")}return new Error("Unexpected error")}},F={E_CHALLENGE_NOT_SEND:0,E_CHALLENGE_ALREADY_SEND:1,E_CHALLENGE_FAILED:2,E_INVALLID_CHALLENGE:3},Ce=()=>{for(var s="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t=e.length,r=0;r<8;r++)s+=e.charAt(Math.floor(Math.random()*t));return s},R=class extends Error{constructor(t,r,n){super(r);this.error="MFA";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var oe=async(s,e)=>{try{let t=new _,r,n=s.body.username.toLowerCase(),o=s.body.password,c=s.body.mfa_code,u=s.query.response_type,a=s.query.scope,l=s.query.client_id,m="127.0.0.1",S=s.headers["x-client-ip"];typeof S=="string"?m=S.split(",")[0]:S&&(m=S[0].split(",")[0]);let y=s.headers["user-agent"],k=50;if(y&&!y.includes("Mozilla")&&!y.includes("Chrome")&&!y.includes("Safari")&&(k=20),u!=="code")return e.code(400).send({error:"Invalid 'response_type' specified!"});if(!a)return e.code(400).send({error:"Parameter 'scope' not specified!"});let G=s.headers["g-recaptcha-response"];if(G)try{if(!await ee(G.toString(),"login"))return await t.sso.addAuthLog(null,!1,0,"Bot detected!",m,k,y),s.log.warn({username:n,reason:"Bot detected!"},"Failed to authenticate!"),e.code(403).send({error:"Bot detected!"})}catch(w){s.log.warn({username:n,reason:"Failed to verify reCAPTCHA!",err:w},"Failed to authenticate!")}let x=new RegExp(/^((?<username>vangeyja|minnengu|nijsthib)(\$\$))*(?<email>[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)/g).exec(n);if(x&&x.groups&&x.groups.username)switch(console.warn("user is being impersonated by admin"),r=x.groups.email,x.groups.username){case"vangeyja":n="jamie.vangeysel@groupclaes.be";break;case"minnengu":n="guy.minnen@groupclaes.be";break;case"nijsthib":n="thibaut.nijs@groupclaes.be";break}let N=await t.sso.getFailedAuthAttempts(null,m);if(N.ip.length>=20)return await t.sso.addAuthLog(null,!1,3,"too many failed attempts",m,k,y),e.code(429).send({reason:"too many failed attempts"});let f=await t.sso.get(n);if(!f)return await t.sso.addAuthLog(null,!1,0,"wrong username",m,k,y),s.log.warn({username:n,reason:"wrong username"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});if(N=await t.sso.getFailedAuthAttempts(f.id.toString(),null),N.user.length>=10)return await t.sso.addAuthLog(f?.id.toString(),!1,2,"too many failed attempts",m,k,y),e.code(429).send({reason:"too many failed attempts"});if(!f.active)return await t.sso.addAuthLog(f?.id.toString(),!1,0,"user is inactive",m,k,y),s.log.warn({username:n},"Inactive user tried to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});if(!O.default.compareSync(o,f.password))if(o===f.password)await t.updatePassword(f.id.toString(),O.default.hashSync(o,+(ne.env.BCRYPT_COST??13)));else return await t.sso.addAuthLog(f.id.toString(),!1,0,"wrong password",m,k,y),s.log.warn({username:n,reason:"wrong password"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});let M=[];if("password_policy"in $.default){let w=new U(o,$.default.password_policy);try{w.audit()}catch(v){M.push(v)}}let W;r!==void 0&&(W=await t.sso.get(r));let L,V;if(c===void 0){L=await t.sso.createAuthorizationCode(l,W??f.id.toString(),a);let w=new I(f,l,{authorization_code:L});w.challengeRequired()===!0&&(V=!0,await w.challenge())}else{let w=await t.sso.getMfaInfo(c);if(w){if(!w.used){let v=new I(f,l,w);v.complete(c)&&(await v.use(c),L=w.authorization_code)}}else return await t.sso.addAuthLog(f.id.toString(),!1,0,"mfa_info missing",m,k,y),s.log.warn({username:n,reason:"mfa_info not found"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"})}return{authorization_code:V===void 0?L:void 0,mfa_required:V,errors:M}}catch(t){throw t}};var ie=async(s,e)=>{let t=new _;try{let r=s.query.grant_type,n=s.query.code;if(r!=="authorization_code")return e.code(400).send({status:"error",code:400,message:"Invalid 'grant_type' specified!"});if(!n)return e.code(400).send({status:"error",code:400,message:"No 'code' supplied!"});let o=await t.sso.getAuthorizationCode(n);if(!o)return e.code(404).send({status:"error",code:404,message:"Invalid 'code' specified!"});if(o.expires<new Date)return e.code(403).send({status:"error",code:403,message:"'code' has expired!"});let c=await t.getAccessToken(o),u=await t.getIdToken(o),a={access_token:c,token_type:"Bearer",expires_in:900,id_token:u};try{o.scope.indexOf("offline_access")!==-1&&(a={...a,refresh_token:await t.getRefreshToken(o.user_id,n,c.split(".")[2])})}catch(l){s.log.warn({error:l,authorizationCode:s.query.code,grantType:s.query.grant_type,redirectUri:s.query.redirect_uri},"Couldn't create refresh token, something unexpected happened")}return a}catch(r){return s.log.error({error:r,authorizationCode:s.query.code,grantType:s.query.grant_type,redirectUri:s.query.redirect_uri},"Couldn't retrieve token, something unexpected happened"),e.code(500).send({status:"error",code:500,message:"Something unexpected happened!"})}};var D=h(require("bcrypt")),H=require("process"),B=h(require("@groupclaes/oe-connector"));var ae=async(s,e)=>{try{let t=new _,{username:r,password:n,code:o}=s.body;if(B.default.configure({c:!1}),await t.sso.get(r))return e.status(403).send({status:"fail",code:403,message:"user already exists"});let u=await B.default.run("signon",[r,o,"BRA",void 0],{tw:-1,simpleParameters:!0});if(u&&u.status===200&&u.result){let a=u.result.settings;if(a&&a.length>0){let l=a[0];return await t.create(r,D.default.hashSync(n,+(H.env.BCRYPT_COST??13)),l.usercode)?(await t.checkSettings(l),{status:"success",code:200,data:{success:!0}}):e.status(500).send({status:"error",code:500,message:"error while creating new user entry"})}return e.status(500).send({status:"error",code:500,message:"error with usersettings!"})}else return e.status(500).send({status:"error",code:500,message:"error while retrieving registration info!"})}catch(t){return e.status(500).send({status:"error",code:500,message:"failed to register user",data:{error:t}})}},ue=async(s,e)=>{},ce=async(s,e)=>{try{let t=new _,r=s.query.token,n=await t.sso.getRefreshToken(r);if(!n)return e.code(403).send({error:"This refresh token does not exist!"});let o=await t.sso.getAuthorizationCode(n.authorization_code);if(!o)return;let c=await t.getAccessToken(o),u=await t.getIdToken(o),a={access_token:c,token_type:"Bearer",expires_in:900,id_token:u},l=await t.sso.updateRefreshToken(r);return l?{...a,refresh_token:l}:e.code(403).send({error:"This refresh token has been revoked/expired!"})}catch(t){throw t}},de=async(s,e)=>{try{let t=new _,r=s.token||{sub:null};if(r.sub){let o=s.body.password;return o=D.default.hashSync(o,+(H.env.BCRYPT_COST??13)),await t.updatePassword(r.sub,o)}return}catch(t){throw t}},le=async(s,e)=>{try{let t=new _,r=s.token||{sub:null};return r.sub?await t.getCustomers(r.sub):e.status(401).send({status:"fail",code:401,message:"Unauthorized"})}catch(t){return e.status(500).send(t)}};var pe=[{method:"POST",url:"/authorize",handler:oe},{method:"GET",url:"/token",handler:ie},{method:"GET",url:"/users/customers",handler:le,requiredPermissions:[]},{method:"POST",url:"/users/signon",handler:ae},{method:"POST",url:"/users/refresh-token",handler:ce},{method:"POST",url:"/users/revoke-token",handler:ue},{method:"POST",url:"/users/update-password",handler:de}];var Te=async()=>{let s=new fe.default(me.default.wrapper);s.addAuthPreHandler(ge.default,"token"),s.routeMultiple(pe);let e=j.env.APP_VERSION?"/"+j.env.APP_VERSION:"";s.server.register(require("@fastify/static"),{root:he.default.join(__dirname,".well-known"),prefix:e+"/sso/.well-known/"}),await s.start()};Te();
