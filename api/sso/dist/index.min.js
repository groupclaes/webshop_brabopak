var Re=Object.create;var W=Object.defineProperty;var Ce=Object.getOwnPropertyDescriptor;var xe=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,Te=Object.prototype.hasOwnProperty;var Ae=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of xe(e))!Te.call(r,n)&&n!==t&&W(r,n,{get:()=>e[n],enumerable:!(s=Ce(e,n))||s.enumerable});return r};var p=(r,e,t)=>(t=r!=null?Re(Ee(r)):{},Ae(e||!r||!r.__esModule?W(t,"default",{value:r,enumerable:!0}):t,r));var _e=p(require("path")),D=require("process"),ye=p(require("@groupclaes/fastify-elastic")),be=p(require("@groupclaes/fastify-authhandler")),ke=p(require("./config"));var H=p(require("bcrypt")),ue=require("process"),z=p(require("./config"));var f=p(require("mssql")),x=p(require("jose"));var J=require("mssql"),Q=require("./config"),P=new Map,l={get:async r=>{if(!P.has(r)){if(!Q.mssql[r])throw new Error(`Configuration for pool '${r}' does not exist!`);let e=new J.ConnectionPool(Q.mssql[r]),t=e.close.bind(e);e.close=(...s)=>(P.delete(r),t(...s)),P.set(r,await e.connect())}return P.get(r)},closeAll:()=>Promise.all(Array.from(P.values()).map(r=>r.then(e=>e.close())))};var Y=p(require("nodemailer")),Z=p(require("fs")),y=p(require("./config"));var a=p(require("mssql"));var h="brabopak",F=class{constructor(){this.schema="[sso]"}async get(e){let t=new a.default.Request(await l.get(h));t.input("username",a.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getUser]`);if(s.recordset.length>0)return s.recordset[0]}async getUserInfo(e){let t=new a.default.Request(await l.get(h));t.input("user_id",a.default.Int,e);let s=await t.execute(`${this.schema}.[usp_getUserInfo]`);if(s.recordset.length>0)return s.recordset[0][0]}async updatePassword(e,t){let s=new a.default.Request(await l.get(h));s.input("user_id",a.default.Int,e),s.input("password",a.default.VarChar,t);let n=await s.execute(`${this.schema}.[usp_updateUserPassword]`);if(n.rowsAffected.length>0)return n.rowsAffected[0]>0}async refreshTokenExists(e){let t=new a.default.Request(await l.get(h));t.input("token",a.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getTokenExists]`);if(s.recordset.length>0)return s.recordset[0].exists}async createAuthorizationCode(e,t,s){let n=new a.default.Request(await l.get(h));n.input("client_id",a.default.VarChar,e),n.input("user_id",a.default.Int,t),n.input("scope",a.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_createAuthorizationCode]`);if(o.recordset.length>0)return o.recordset[0].code}async getAuthorizationCode(e){let t=new a.default.Request(await l.get(h));t.input("code",a.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getAuthorizationCode]`);if(s.recordset.length>0)return s.recordset[0]}async createRefreshToken(e,t,s){let n=new a.default.Request(await l.get(h));n.input("user_id",a.default.Int,e),n.input("authorization_code",a.default.VarChar,t),n.input("access_token",a.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_createRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getRefreshToken(e){let t=new a.default.Request(await l.get(h));t.input("token",a.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getRefreshToken]`);if(s.recordset.length>0)return s.recordset[0]}async updateRefreshToken(e){let t=new a.default.Request(await l.get(h));t.input("token",a.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_updateRefreshToken]`);if(s.recordset)return s.recordset[0].token}async revokeRefreshToken(e,t,s){let n=new a.default.Request(await l.get(h));n.input("token",a.default.VarChar,e),n.input("reason_revoked",a.default.VarChar,t),n.input("replaced_by_token",a.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_revokeRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getMfaInfo(e){let t=new a.default.Request(await l.get(h));t.input("mfa_code",a.default.VarChar,e);let s=await t.execute(`${this.schema}[usp_getMfaInfo]`);if(s.recordset.length>0)return s.recordset[0]}async addAuthLog(e,t=!1,s=0,n=null,o="127.0.0.1",c=50,u=null){let i=new a.default.Request(await l.get(h));e===void 0&&(e=null),i.input("user_id",a.default.Int,e),i.input("client_id",a.default.VarChar,"hBK4c2uZK5"),i.input("success",a.default.Bit,t),i.input("result",a.default.TinyInt,s),i.input("reason",a.default.VarChar,n),i.input("ip",a.default.VarChar,o),i.input("rating",a.default.TinyInt,c),i.input("user_agent",a.default.VarChar,u);let d=await i.execute(`${this.schema}.[usp_addAuthLog]`);if(d.rowsAffected.length>0)return d.rowsAffected[0]>0}async getFailedAuthAttempts(e=null,t=null){let s=new a.default.Request(await l.get(h));s.input("user_id",a.default.Int,e),s.input("ip",a.default.VarChar,t);let n=await s.execute(`${this.schema}.[usp_getFailedAuthAttempts]`);return n.recordsets.length>0?{user:n.recordsets[0]??[],ip:n.recordsets[1]??[]}:{user:[],ip:[]}}async createResetToken(e,t="127.0.0.1"){let s=new a.default.Request(await l.get(h));return s.input("user_id",a.default.Int,e),s.input("ip",a.default.VarChar,t),(await s.execute(`${this.schema}.[usp_createResetToken]`)).recordset[0]?.token}async revokeResetToken(e,t="127.0.0.1",s){let n=new a.default.Request(await l.get(h));n.input("token",a.default.VarChar,e),n.input("ip",a.default.VarChar,t),n.input("reason",a.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_revokeResetToken]`);return o.rowsAffected?.length>0&&o.rowsAffected[0]>0}async getResetToken(e){let t=new a.default.Request(await l.get(h));return t.input("token",a.default.VarChar,e),(await t.execute(`${this.schema}.[usp_getResetToken]`)).recordset[0]?.user_id}};var K=900,O="brabopak",w=class{constructor(){this.schema="[sso]";this.updatePassword=(e,t)=>this.sso.updatePassword(e,t);this.getAudSub=e=>({audience:[process.env.CLIENT_ID??"unknown"],subject:e.toString()});this.sso=new F}async getIdToken(e){let{audience:t,subject:s}=this.getAudSub(e.user_id),n=await this.sso.getUserInfo(e.user_id),o,c=e.scope.split(" ");for(let[i,d]of Object.entries(n))o||(o={}),c.indexOf(i)!==-1&&(o[i]=d);if(!o)throw new Error("Invalid payload");let u=await x.importJWK(y.default.key);return await new x.SignJWT(o).setProtectedHeader({alg:y.default.key.alg,kid:y.default.key.kid,jku:y.default.key.iss}).setIssuer(y.default.key.iss).setAudience(t).setExpirationTime(K+"s").setSubject(s).sign(u)}async getAccessToken(e){let{audience:t,subject:s}=this.getAudSub(e.user_id),n=await x.importJWK(y.default.key);return await new x.SignJWT({}).setProtectedHeader({alg:y.default.key.alg,kid:y.default.key.kid,jku:y.default.key.iss}).setIssuer(y.default.key.iss).setAudience(t).setExpirationTime(K+"s").setSubject(s).sign(n)}getRefreshToken(e,t,s){return this.sso.createRefreshToken(e,t,s)}async create(e,t,s){let n=new f.default.Request(await l.get(O));return n.input("username",f.default.VarChar,e),n.input("password",f.default.VarChar,t),n.input("usercode",f.default.Int,s),(await n.execute(`${this.schema}.[usp_createUser]`)).rowsAffected[0]>0}async checkSettings(e){let t=new f.default.Request(await l.get(O));return t.input("usercode",f.default.Int,e.usercode),t.input("user_type",f.default.Int,e.user_type),t.input("customer_id",f.default.Int,e.customer_id),t.input("address_id",f.default.Int,e.address_id),t.input("group_id",f.default.Int,e.group_id),t.input("promo",f.default.Bit,e.promo),t.input("bonus_percentage",f.default.Numeric,e.bonus_percentage),t.input("fostplus",f.default.Bit,e.fostplus),t.input("customer_type",f.default.TinyInt,e.customer_type),t.input("price_class",f.default.Int,e.price_class),(await t.execute(`${this.schema}.[usp_createOrUpdateSettings]`)).rowsAffected[0]>0}async getCustomers(e){let t=new f.default.Request(await l.get(O));t.input("user_id",f.default.Int,e);let s=await t.execute(`${this.schema}.[usp_getCustomers]`);if(s.recordset.length>0)return s.recordset[0]}async sendResetToken(e,t,s,n="nl"){let o=Y.default.createTransport({host:"debian-smtp.groupclaes.be",port:25,secure:!1}),c=n==="nl"?"Wachtwoordherstel":"Herstel de la woord de pass",u=Z.default.readFileSync(`./templates/template_${n}.html`).toString("utf-8"),i=`<a href="https://test.brabopak.com/${n}/auth/reset-password?login_hint=${encodeURI(e)}&reset_token=${s}"><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#ffffff" align="center" style="padding:30px 30px 40px"><table border="0" cellspacing="0" cellpadding="0"><tr><td align="center" style="border-radius:3px;" bgcolor="#001dbb"><span style="pointer-events:none;font-size:20px;font-family:Helvetica,Arial,sans-serif;color:#ffffff;text-decoration:none;color:#ffffff;text-decoration:none;padding:15px 25px;border-radius:2px;border:1px solid #24704C;display:inline-block;">@Button.Text</span></td></tr></table></td></tr></table></a>`;u=u.replace("@RenderTitle()",c);let d=`Hey ${t}, wachtwoord vergeten<br><br>Geen nood met 1 druk op de knop maak je een nieuw wachtwoord aan.`;i=i.replace("@Button.Text","Wachtwoord opnieuw instellen");let b='Als je vragen hebt of om welke reden dan ook hulp nodig hebt, neem dan contact op met ons via <a href="mailto:info@brabopak.com" style="text-decoration:underline;">info@brabopak.com</a>.<br><br>Met vriendelijke groeten<br>Het ICT Team van Group Claes';return u=u.replace("@RenderHeader()",c),u=u.replace("@RenderBody()",d+i+b),await o.sendMail({from:'"Brabopak - webshop"<bestel@brabopak.com>',to:e,subject:c,text:c,html:u})}};var X=p(require("https")),ee=require("process");async function te(r,e){return new Promise((t,s)=>{let n=X.default.request(`https://www.google.com/recaptcha/api/siteverify?secret=${ee.env.GOOGLE_API}&response=${r}`,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"}},o=>{let c="";o.on("data",u=>{c+=u}),o.on("end",u=>{let i=c&&typeof c=="string"?JSON.parse(c):c;if(c=null,!i){s("Could not verify reCAPTCHA!");return}e&&i.action!==e&&s("Actions do not match!"),i["error-codes"]&&i["error-codes"].length>0&&s(i["error-codes"]),t(i.success)}),o.on("error",u=>{s(u)})});n.on("error",o=>{s(o)}),n.end()})}var U=class{constructor(e,t){this._minLength=8;this._maxLength=128;this._requireLowercase=!1;this._requireUppercase=!1;this._requireDigits=!1;this._password=e,t&&(this._minLength=t.min_length||this._minLength,this._maxLength=t.max_length||this._maxLength,this._requireLowercase=t.require_digits||this._requireLowercase,this._requireUppercase=t.require_uppercase||this._requireUppercase,this._requireDigits=t.require_lowercase||this._requireDigits)}audit(){if(this._password.length<this._minLength)throw this.resolveError(I.E_MIN_LENGTH);if(this._password.length>this._maxLength)throw this.resolveError(I.E_MAX_LENGTH);if(this._requireDigits&&this._password.split("").some(e=>e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57))throw this.resolveError(I.E_REQUIRE_DIGITS);if(this._requireUppercase&&this._password.split("").some(e=>e.charCodeAt(0)>=65&&e.charCodeAt(0)<=90))throw this.resolveError(I.E_REQUIRE_UPPERCASE);if(this._requireLowercase&&this._password.split("").some(e=>e.charCodeAt(0)>=97&&e.charCodeAt(0)<=122))throw this.resolveError(I.E_REQUIRE_LOWECASE);return!0}resolveError(e){switch(e){case 0:return new R(e,`Password length must be at least ${this._minLength} characters long.`,{length:this._minLength});case 1:return new R(e,`Password length must be at most ${this._maxLength} characters long.`,{length:this._maxLength});case 2:return new R(e,"Password must contain at least one digit.");case 3:return new R(e,"Password must contain at least one uppercase character.");case 4:return new R(e,"Password must contain at least one lowercase character.")}return new Error("Unexpected error")}},I={E_MIN_LENGTH:0,E_MAX_LENGTH:1,E_REQUIRE_DIGITS:2,E_REQUIRE_UPPERCASE:3,E_REQUIRE_LOWECASE:4},R=class extends Error{constructor(t,s,n){super(s);this.error="PasswordPolicy";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var C=p(require("mssql")),se=p(require("nodemailer")),ne=p(require("fs")),oe=p(require("crypto"));var re="brabopak",v=class{constructor(e,t,s){this._user=e,this._client_id=t,this._info=s}challengeRequired(){return!1}async challenge(e="nl"){if(!this._user.email)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let t=Pe(),s=new C.default.Request(await l.get(re));if(s.input("mfa_code",C.default.VarChar,t),s.input("user_id",C.default.Int,this._user.id),s.input("authorization_code",C.default.VarChar,this._info.authorization_code),(await s.query("INSERT INTO [sso].[mfaCodes] (code, userId, authorizationCode) VALUES (@mfa_code, @user_id, @authorization_code)")).rowsAffected[0]<=0)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let o=se.default.createTransport({host:"debian-smtp.groupclaes.be",port:25,secure:!1}),c=e==="nl"?"Meervoudige authenticatie":"Authentification multiple",u=ne.default.readFileSync(`./templates/template_${e}.html`).toString("utf-8"),i='<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#ffffff" align="center" style="padding:30px 30px 40px"><table border="0" cellspacing="0" cellpadding="0"><tr><td align="center" style="border-radius:3px;" bgcolor="#40ab86"><span style="pointer-events:none;font-size:20px;font-family:Helvetica,Arial,sans-serif;color:#ffffff;text-decoration:none;color:#ffffff;text-decoration:none;padding:15px 25px;border-radius:2px;border:1px solid #24704C;display:inline-block;">@Button.Text</span></td></tr></table></td></tr></table>';u=u.replace("@RenderTitle()",c);let d="Geef onderstaande code in om toegang te krijgen tot de applicatie.";i=i.replace("@Button.Text",t);let b='Als je vragen hebt of om welke reden dan ook hulp nodig hebt, neem dan contact op met ons via <a href="mailto:it@groupclaes.be" style="color:#40ab86;text-decoration:underline;">it@groupclaes.be</a>.<br><br>Met vriendelijke groeten<br>Het ICT Team van Group Claes';u=u.replace("@RenderHeader()",c+" \u2714"),u=u.replace("@RenderBody()",d+i+b),await o.sendMail({from:'"Brabopak - webshop"<bestel@brabopak.com>',to:this._user.email,subject:c,text:c,html:u})}complete(e){if(e.length!==8)throw this.resolveError(q.E_INVALLID_CHALLENGE);if(this._info.code===e&&this._info.user_id===this._user.id)return!0;throw this.resolveError(q.E_CHALLENGE_FAILED)}async use(e){let t=new C.default.Request(await l.get(re));return t.input("mfa_code",C.default.VarChar,e),(await t.query("UPDATE [sso].[mfaCodes] SET used = CAST(1 AS BIT) WHERE code = @mfa_code")).rowsAffected[0]>0}resolveError(e){switch(e){case 0:return new E(e,"Failed to send challenge.");case 1:return new E(e,"Challenge already send.");case 2:return new E(e,"Challenge failed.");case 3:return new E(e,"Invallid challenge.")}return new Error("Unexpected error")}},q={E_CHALLENGE_NOT_SEND:0,E_CHALLENGE_ALREADY_SEND:1,E_CHALLENGE_FAILED:2,E_INVALLID_CHALLENGE:3},Pe=()=>{let r="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";oe.default.getRandomValues(new Uint32Array(e.length));for(let t=0;t<8;t++)r+=e.charAt(Math.floor(Ie()*e.length));return r},Ie=function(){return window.crypto.getRandomValues(new Uint32Array(1))[0]/2**32},E=class extends Error{constructor(t,s,n){super(s);this.error="MFA";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var ve=new RegExp(/^((?<username>vangeyja|minnengu|nijsthib)(\$\$))*(?<email>[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)/g);function ie(r){return r?!r.includes("Mozilla")&&!r.includes("Chrome")&&!r.includes("Safari")?20:50:0}function ae(r){let e=ve.exec(r);if(!e?.groups?.username)return;let t=e.groups.email;switch(e.groups.username){case"vangeyja":r="jamie.vangeysel@groupclaes.be";break;case"minnengu":r="guy.minnen@groupclaes.be";break;case"nijsthib":r="thibaut.nijs@groupclaes.be";break}return{username:r,impersonated_user:t}}var ce=async(r,e)=>{try{let t=new w,s,n=r.body.username.toLowerCase(),o=r.body.password,c="127.0.0.1",u=r.headers["x-client-ip"];typeof u=="string"?c=u.split(",")[0]:u&&(c=u[0].split(",")[0]);let i=r.headers["user-agent"],d=ie(i);if(!r.query.response_type)return N(r,e,"parameter 'response_type' not specified!");if(r.query.response_type!=="code")return N(r,e,"invalid 'response_type' specified!");if(!r.query.scope)return N(r,e,"parameter 'scope' not specified!");if(!r.query.client_id)return N(r,e,"parameter 'client_id' not specified!");let b=r.headers["g-recaptcha-response"];if(b)try{if(!await te(b.toString(),"login"))return await k(r,e,t,403,"Bot detected!",n,null,!1,0,"Bot detected!",c,d,i)}catch(_){r.log.warn({username:n,reason:"Failed to verify reCAPTCHA!",err:_},"Failed to authenticate!")}else return await k(r,e,t,403,"No reCAPTCHA challenge!",n,null,!1,0,"No reCAPTCHA challenge!",c,d,i);let T=ae(n);T&&(n=T.username,s=T.impersonated_user);let A=await t.sso.getFailedAuthAttempts(null,c);if(A.ip.length>=20)return await k(r,e,t,429,"too many failed attempts",n,null,!1,3,"too many failed attempts",c,d,i);let m=await t.sso.get(n);if(!m)return await k(r,e,t,404,"Username or password is incorrect!",n,null,!1,0,"wrong username",c,d,i);if(A=await t.sso.getFailedAuthAttempts(m.id.toString(),null),A.user.length>=10)return await k(r,e,t,429,"too many failed attempts",n,m.id.toString(),!1,2,"too many failed attempts",c,d,i);if(!m.active)return await k(r,e,t,404,"Username or password is incorrect!",n,m.id.toString(),!1,0,"user is inactive",c,d,i);if(!H.default.compareSync(o,m.password))if(o===m.password)await t.updatePassword(m.id.toString(),H.default.hashSync(o,+(ue.env.BCRYPT_COST??13)));else return await k(r,e,t,404,"Username or password is incorrect!",n,m.id.toString(),!1,0,"wrong password",c,d,i);let G=[];if("password_policy"in z.default){let _=new U(o,z.default.password_policy);try{_.audit()}catch(L){G.push(L)}}let M;s!==void 0&&(M=await t.sso.get(s));let S,B;if(r.body.mfa_code===void 0){S=await t.sso.createAuthorizationCode(r.query.client_id,M??m.id.toString(),r.query.scope);let _=new v(m,r.query.client_id,{authorization_code:S});_.challengeRequired()===!0&&(B=!0,await _.challenge())}else{let _=await t.sso.getMfaInfo(r.body.mfa_code);if(_){if(!_.used){let L=new v(m,r.query.client_id,_);L.complete(r.body.mfa_code)&&(await L.use(r.body.mfa_code),S=_.authorization_code)}}else return await k(r,e,t,404,"Username or password is incorrect!",n,m.id.toString(),!1,0,"mfa_info missing",c,d,i)}return{authorization_code:B===void 0?S:void 0,mfa_required:B,errors:G}}catch(t){throw t}};function N(r,e,t){return r.log.warn(t),e.code(400).send({error:t})}async function k(r,e,t,s,n,o,c,u=!1,i=0,d=null,b="127.0.0.1",T=50,A=null){return await t.sso.addAuthLog(c,u,i,d,b,T,A),r.log.warn({username:o,reason:d},"Failed to authenticate!"),e.code(s).send({error:n})}var de=async(r,e)=>{let t=new w;try{let s=r.query.grant_type,n=r.query.code;if(s!=="authorization_code")return r.log.warn("Invalid 'grant_type' specified!"),e.code(400).send({status:"error",code:400,message:"Invalid 'grant_type' specified!"});if(!n)return r.log.warn("Parameter 'code' not specified!"),e.code(400).send({status:"error",code:400,message:"No 'code' supplied!"});let o=await t.sso.getAuthorizationCode(n);if(!o)return r.log.warn("Invalid 'code' specified!"),e.code(404).send({status:"error",code:404,message:"Invalid 'code' specified!"});if(o.expires<new Date)return r.log.warn("'code' has expired!"),e.code(403).send({status:"error",code:403,message:"'code' has expired!"});let c=await t.getAccessToken(o),u=await t.getIdToken(o),i={access_token:c,token_type:"Bearer",expires_in:900,id_token:u};try{o.scope.indexOf("offline_access")!==-1&&(i={...i,refresh_token:await t.getRefreshToken(o.user_id,n,c.split(".")[2])})}catch(d){r.log.warn({error:d,authorizationCode:r.query.code,grantType:r.query.grant_type,redirectUri:r.query.redirect_uri},"Couldn't create refresh token, something unexpected happened")}return i}catch(s){return r.log.error({error:s,authorizationCode:r.query.code,grantType:r.query.grant_type,redirectUri:r.query.redirect_uri},"Couldn't retrieve token, something unexpected happened"),e.code(500).send({status:"error",code:500,message:"Something unexpected happened!"})}};var V=p(require("bcrypt")),$=require("process"),g=require("@groupclaes/fastify-elastic/responses"),j=p(require("@groupclaes/oe-connector"));var le=async(r,e)=>{try{let t=new w,{username:s,password:n,code:o}=r.body;if(j.default.configure({c:!1}),await t.sso.get(s))return r.log.warn({username:s,code:o,reason:"user already exists"},"Failed to register!"),e.status(403).send({status:"fail",code:403,message:"user already exists"});let u=await j.default.run("signon",[s,o,"BRA",void 0],{tw:-1,simpleParameters:!0});if(u&&u.status===200&&u.result){let i=u.result.settings;if(i&&i.length>0){let d=i[0];return await t.create(s,V.default.hashSync(n,+($.env.BCRYPT_COST??13)),d.usercode)?(await t.checkSettings(d),r.log.debug({username:s,code:o},"User successfully registered!"),{status:"success",code:200,data:{success:!0}}):(r.log.debug({username:s,code:o,reason:"error while creating new user entry"},"Failed to register user!"),e.status(500).send({status:"error",code:500,message:"error while creating new user entry"}))}return r.log.debug({username:s,code:o,reason:"error with usersettings!"},"Failed to register user!"),e.status(500).send({status:"error",code:500,message:"error with usersettings!"})}else return r.log.debug({username:s,code:o,reason:"error while retrieving registration info!"},"Failed to register user!"),e.status(500).send({status:"error",code:500,message:"error while retrieving registration info!"})}catch(t){return r.log.debug({reason:"unknown error",err:t},"Failed to register user!"),(0,g.error)(e,"failed to register user")}},pe=async(r,e)=>(0,g.fail)(e,{reason:"Method not implemented"}),fe=async(r,e)=>{try{let t=new w,s=r.query.token,n=await t.sso.getRefreshToken(s);if(!n)return e.code(403).send({error:"This refresh token does not exist!"});let o=await t.sso.getAuthorizationCode(n.authorization_code);if(!o)return;let c=await t.getAccessToken(o),u=await t.getIdToken(o),i={access_token:c,token_type:"Bearer",expires_in:900,id_token:u},d=await t.sso.updateRefreshToken(s);return d?{...i,refresh_token:d}:e.code(403).send({error:"This refresh token has been revoked/expired!"})}catch(t){throw t}},ge=async(r,e)=>{try{let t=new w,s=r.token||{sub:null};if(s.sub){let o=r.body.password;return o=V.default.hashSync(o,+($.env.BCRYPT_COST??13)),await t.updatePassword(s.sub,o)}return}catch(t){return r.log.error({err:t},"error while updating password"),(0,g.error)(e,"error while updating password")}},he=async(r,e)=>{let t="127.0.0.1",s=r.headers["x-client-ip"];typeof s=="string"?t=s.split(",")[0]:s&&(t=s[0].split(",")[0]);let n=r.query.culture??"nl";try{let o=new w,c=await o.sso.get(r.body.username);if(!c?.active)return(0,g.fail)(e,{username:"account not found!"});if(r.query.reset_token){let u=await o.sso.getResetToken(r.query.reset_token);if(!u)return(0,g.fail)(e,{reset_token:"token not found!"});if(!r.body.password)return(0,g.fail)(e,{password:"missing in payload"});let i=V.default.hashSync(r.body.password,+($.env.BCRYPT_COST??13));return await o.updatePassword(u,i)?(await o.sso.revokeResetToken(r.query.reset_token,t,"used"),(0,g.success)(e,{success:!0})):(0,g.error)(e,"failed to update password in db")}else{let u=await o.sso.createResetToken(c.id.toString(),t);return u?(await o.sendResetToken(c.username,c.given_name,u,n),(0,g.success)(e,{success:!0})):(0,g.error)(e,"error creating new reset token")}}catch(o){return r.log.error({err:o},"error while requesting password reset"),(0,g.error)(e,"error while requesting password reset")}},me=async(r,e)=>{let t=performance.now();try{let s=new w,n=r.token;if(n.sub){let o=await s.getCustomers(n.sub);return o?.length??0>0?(0,g.success)(e,{customers:o},200,performance.now()-t):(0,g.success)(e,{customers:[]},200,performance.now()-t)}return(0,g.fail)(e,{token:"precondition failed"})}catch(s){return r.log.error({err:s},"could not fetch customers"),(0,g.error)(e,"could not fetch customers")}};var we=[{method:"POST",url:"/authorize",handler:ce},{method:"GET",url:"/token",handler:de},{method:"GET",url:"/users/customers",handler:me,requiredPermissions:[void 0]},{method:"POST",url:"/users/signon",handler:le},{method:"POST",url:"/users/refresh-token",handler:fe},{method:"POST",url:"/users/revoke-token",handler:pe},{method:"POST",url:"/users/update-password",handler:ge},{method:"POST",url:"/users/reset-password",handler:he}];var Ue=async()=>{let r=new ye.default(ke.default.wrapper);r.addAuthPreHandler(be.default,"token"),r.routeMultiple(we);let e=D.env.APP_VERSION?"/"+D.env.APP_VERSION:"";r.server.register(require("@fastify/static"),{root:_e.default.join(__dirname,".well-known"),prefix:e+"/sso/.well-known/"}),await r.start()};Ue();
