var ue=Object.create;var D=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var pe=Object.getOwnPropertyNames;var he=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty;var ge=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of pe(e))!fe.call(s,o)&&o!==t&&D(s,o,{get:()=>e[o],enumerable:!(r=le(e,o))||r.enumerable});return s};var p=(s,e,t)=>(t=s!=null?ue(he(s)):{},ge(e||!s||!s.__esModule?D(t,"default",{value:s,enumerable:!0}):t,s));var ie=p(require("path")),z=require("process"),ae=p(require("@groupclaes/fastify-elastic")),ce=p(require("@groupclaes/fastify-authhandler")),de=p(require("./config"));var U=p(require("bcrypt")),Y=require("process"),V=p(require("./config"));var A=p(require("mssql")),C=p(require("jose"));var B=require("mssql"),H=require("./config"),R=new Map,l={get:async s=>{if(!R.has(s)){if(!H.mssql[s])throw new Error(`Configuration for pool '${s}' does not exist!`);let e=new B.ConnectionPool(H.mssql[s]),t=e.close.bind(e);e.close=(...r)=>(R.delete(s),t(...r)),R.set(s,await e.connect())}return R.get(s)},closeAll:()=>Promise.all(Array.from(R.values()).map(s=>s.then(e=>e.close())))};var m=p(require("./config"));var i=p(require("mssql"));var f="brabopak",v=class{constructor(){this.schema="[sso]"}async get(e){let t=new i.default.Request(await l.get(f));t.input("username",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getUser]`);if(r.recordset.length>0)return r.recordset[0]}async getUserInfo(e){let t=new i.default.Request(await l.get(f));t.input("user_id",i.default.Int,e);let r=await t.execute(`${this.schema}.[usp_getUserInfo]`);if(r.recordset.length>0)return r.recordset[0]}async updatePassword(e,t){let r=new i.default.Request(await l.get(f));r.input("user_id",i.default.Int,e),r.input("password",i.default.VarChar,t);let o=await r.execute(`${this.schema}.[usp_updateUserPassword]`);if(o.recordset.length>0)return o.rowsAffected[0]>0}async refreshTokenExists(e){let t=new i.default.Request(await l.get(f));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getTokenExists]`);if(r.recordset.length>0)return r.recordset[0].exists}async createAuthorizationCode(e,t){let r=new i.default.Request(await l.get(f));r.input("user_id",i.default.Int,e),r.input("scope",i.default.VarChar,t);let o=await r.execute(`${this.schema}.[usp_createAuthorizationCode]`);if(o.recordset.length>0)return o.recordset[0].code}async getAuthorizationCode(e){let t=new i.default.Request(await l.get(f));t.input("code",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getAuthorizationCode]`);if(r.recordset.length>0)return r.recordset[0]}async createRefreshToken(e,t,r){let o=new i.default.Request(await l.get(f));o.input("user_id",i.default.Int,e),o.input("authorization_code",i.default.VarChar,t),o.input("access_token",i.default.VarChar,r);let n=await o.execute(`${this.schema}.[usp_createRefreshToken]`);if(n.recordset.length>0)return n.recordset[0].token}async getRefreshToken(e){let t=new i.default.Request(await l.get(f));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getRefreshToken]`);if(r.recordset.length>0)return r.recordset[0]}async updateRefreshToken(e){let t=new i.default.Request(await l.get(f));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_updateRefreshToken]`);if(r.recordset)return r.recordset[0].token}async revokeRefreshToken(e,t,r){let o=new i.default.Request(await l.get(f));o.input("token",i.default.VarChar,e),o.input("reason_revoked",i.default.VarChar,t),o.input("replaced_by_token",i.default.VarChar,r);let n=await o.execute(`${this.schema}.[usp_revokeRefreshToken]`);if(n.recordset.length>0)return n.recordset[0].token}async getMfaInfo(e){let t=new i.default.Request(await l.get(f));t.input("mfa_code",i.default.VarChar,e);let r=await t.execute(`${this.schema}[usp_getMfaInfo]`);if(r.recordset.length>0)return r.recordset[0]}async addAuthLog(e,t=!1,r=0,o=null,n="127.0.0.1",c=50,d=null){let a=new i.default.Request(await l.get(f));e===void 0&&(e=null),a.input("user_id",i.default.Int,e),a.input("client_id",i.default.VarChar,"hBK4c2uZK5"),a.input("success",i.default.Bit,t),a.input("result",i.default.TinyInt,r),a.input("reason",i.default.VarChar,o),a.input("ip",i.default.VarChar,n),a.input("rating",i.default.TinyInt,c),a.input("user_agent",i.default.VarChar,d);let u=await a.execute(`${this.schema}.[usp_addAuthLog]`);if(u.rowsAffected.length>0)return u.rowsAffected[0]>0}async getFailedAuthAttempts(e=null,t=null){let r=new i.default.Request(await l.get(f));r.input("user_id",i.default.Int,e),r.input("ip",i.default.VarChar,t);let o=await r.execute(`${this.schema}.[usp_getFailedAuthAttempts]`);return o.recordsets.length>0?{user:o.recordsets[0]??[],ip:o.recordsets[1]??[]}:{user:[],ip:[]}}};var G=900,me="brabopak",_=class{constructor(){this.schema="[sso]";this.updatePassword=(e,t)=>this.sso.updatePassword(e,t);this.getAudSub=e=>({audience:[m.default.key.iss],subject:e.toString()});this.sso=new v}async getIdToken(e){let{audience:t,subject:r}=this.getAudSub(e.user_id),o=await this.sso.getUserInfo(e.user_id),n,c=e.scope.split(" ");for(let[a,u]of Object.entries(o))n||(n={}),c.indexOf(a)!==-1&&(n[a]=u);if(!n)throw new Error("Invalid payload");let d=await C.importJWK(m.default.key);return await new C.SignJWT(n).setProtectedHeader({alg:m.default.key.alg,kid:m.default.key.kid,jku:m.default.key.jku}).setIssuer(m.default.key.iss).setAudience(t).setExpirationTime(G+"s").setSubject(r).sign(d)}async getAccessToken(e){let{audience:t,subject:r}=this.getAudSub(e.user_id),o=await C.importJWK(m.default.key);return await new C.SignJWT({roles:["*"]}).setProtectedHeader({alg:m.default.key.alg,kid:m.default.key.kid,jku:m.default.key.jku}).setIssuer(m.default.key.iss).setAudience(t).setExpirationTime(G+"s").setSubject(r).sign(o)}getRefreshToken(e,t,r){return this.sso.createRefreshToken(e,t,r)}async create(e,t,r,o){let n=new A.default.Request(await l.get(me));return n.input("email",A.default.VarChar,e),n.input("password",A.default.VarChar,t),n.input("given_name",A.default.VarChar,r),n.input("family_name",A.default.VarChar,o),(await n.execute(`${this.schema}.[usp_createUser]`)).rowsAffected[0]>0}};var M=p(require("https")),j=require("process");async function Q(s,e){return new Promise((t,r)=>{let o=M.default.request(`https://www.google.com/recaptcha/api/siteverify?secret=${j.env.GOOGLE_API}&response=${s}`,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"}},n=>{let c="";n.on("data",d=>{c+=d}),n.on("end",d=>{let a=c&&typeof c=="string"?JSON.parse(c):c;if(c=null,!a){r("Could not verify reCAPTCHA!");return}e&&a.action!==e&&r("Actions do not match!"),a["error-codes"]&&a["error-codes"].length>0&&r(a["error-codes"]),t(a.success)}),n.on("error",d=>{r(d)})});o.on("error",n=>{r(n)}),o.end()})}var S=class{constructor(e,t){this._minLength=8;this._maxLength=128;this._requireLowercase=!1;this._requireUppercase=!1;this._requireDigits=!1;this._password=e,t&&(this._minLength=t.min_length||this._minLength,this._maxLength=t.max_length||this._maxLength,this._requireLowercase=t.require_digits||this._requireLowercase,this._requireUppercase=t.require_uppercase||this._requireUppercase,this._requireDigits=t.require_lowercase||this._requireDigits)}audit(){if(this._password.length<this._minLength)throw this.resolveError(T.E_MIN_LENGTH);if(this._password.length>this._maxLength)throw this.resolveError(T.E_MAX_LENGTH);if(this._requireDigits&&this._password.split("").some(e=>e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57))throw this.resolveError(T.E_REQUIRE_DIGITS);if(this._requireUppercase&&this._password.split("").some(e=>e.charCodeAt(0)>=65&&e.charCodeAt(0)<=90))throw this.resolveError(T.E_REQUIRE_UPPERCASE);if(this._requireLowercase&&this._password.split("").some(e=>e.charCodeAt(0)>=97&&e.charCodeAt(0)<=122))throw this.resolveError(T.E_REQUIRE_LOWECASE);return!0}resolveError(e){switch(e){case 0:return new k(e,`Password length must be at least ${this._minLength} characters long.`,{length:this._minLength});case 1:return new k(e,`Password length must be at most ${this._maxLength} characters long.`,{length:this._maxLength});case 2:return new k(e,"Password must contain at least one digit.");case 3:return new k(e,"Password must contain at least one uppercase character.");case 4:return new k(e,"Password must contain at least one lowercase character.")}return new Error("Unexpected error")}},T={E_MIN_LENGTH:0,E_MAX_LENGTH:1,E_REQUIRE_DIGITS:2,E_REQUIRE_UPPERCASE:3,E_REQUIRE_LOWECASE:4},k=class extends Error{constructor(t,r,o){super(r);this.error="PasswordPolicy";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,o&&(this.args=o)}};var E=p(require("mssql")),K=p(require("nodemailer")),J=p(require("fs"));var W="brabopak",P=class{constructor(e,t,r){this._user=e,this._client_id=t,this._info=r}challengeRequired(){return this._client_id==="hBK4c2uZK5"}async challenge(e="nl"){if(!this._user.email)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let t=we(),r=new E.default.Request(await l.get(W));if(r.input("mfa_code",E.default.VarChar,t),r.input("user_id",E.default.Int,this._user.id),r.input("authorization_code",E.default.VarChar,this._info.authorization_code),(await r.query("INSERT INTO [sso].[mfaCodes] (code, userId, authorizationCode) VALUES (@mfa_code, @user_id, @authorization_code)")).rowsAffected[0]<=0)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let n=K.default.createTransport({host:"debian-smtp.groupclaes.be",port:25,secure:!1}),c=e==="nl"?"Meervoudige authenticatie":"Authentification multiple",d=J.default.readFileSync(`./templates/template_${e}.html`).toString("utf-8"),a='<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#ffffff" align="center" style="padding:30px 30px 40px"><table border="0" cellspacing="0" cellpadding="0"><tr><td align="center" style="border-radius:3px;" bgcolor="#40ab86"><span style="pointer-events:none;font-size:20px;font-family:Helvetica,Arial,sans-serif;color:#ffffff;text-decoration:none;color:#ffffff;text-decoration:none;padding:15px 25px;border-radius:2px;border:1px solid #24704C;display:inline-block;">@Button.Text</span></td></tr></table></td></tr></table>';d=d.replace("@RenderTitle()",c);let u="Geef onderstaande code in om toegang te krijgen tot de applicatie.";a=a.replace("@Button.Text",t);let b='Als je vragen hebt of om welke reden dan ook hulp nodig hebt, neem dan contact op met ons via <a href="mailto:it@groupclaes.be" style="color:#40ab86;text-decoration:underline;">it@groupclaes.be</a>.<br><br>Met vriendelijke groeten<br>Het ICT Team van Group Claes';d=d.replace("@RenderHeader()",c+" \u2714"),d=d.replace("@RenderBody()",u+a+b),await n.sendMail({from:'"Brabopak - webshop"<bestel@brabopak.com>',to:this._user.email,subject:c,text:c,html:d})}complete(e){if(e.length!==8)throw this.resolveError(q.E_INVALLID_CHALLENGE);if(this._info.code===e&&this._info.user_id===this._user.id)return!0;throw this.resolveError(q.E_CHALLENGE_FAILED)}async use(e){let t=new E.default.Request(await l.get(W));return t.input("mfa_code",E.default.VarChar,e),(await t.query("UPDATE [sso].[mfaCodes] SET used = CAST(1 AS BIT) WHERE code = @mfa_code")).rowsAffected[0]>0}resolveError(e){switch(e){case 0:return new x(e,"Failed to send challenge.");case 1:return new x(e,"Challenge already send.");case 2:return new x(e,"Challenge failed.");case 3:return new x(e,"Invallid challenge.")}return new Error("Unexpected error")}},q={E_CHALLENGE_NOT_SEND:0,E_CHALLENGE_ALREADY_SEND:1,E_CHALLENGE_FAILED:2,E_INVALLID_CHALLENGE:3},we=()=>{for(var s="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t=e.length,r=0;r<8;r++)s+=e.charAt(Math.floor(Math.random()*t));return s},x=class extends Error{constructor(t,r,o){super(r);this.error="MFA";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,o&&(this.args=o)}};var X=async(s,e)=>{try{let t=new _,r=s.body.username,o=s.body.password,n=s.body.mfa_code,c=s.query.response_type,d=s.query.scope,a=s.query.client_id,u="127.0.0.1",b=s.headers["x-client-ip"];typeof b=="string"?u=b.split(",")[0]:b&&(u=b[0].split(",")[0]);let w=s.headers["user-agent"],y=50;if(w&&!w.includes("Mozilla")&&!w.includes("Chrome")&&!w.includes("Safari")&&(y=20),c!=="code")return e.code(400).send({error:"Invalid 'response_type' specified!"});if(!d)return e.code(400).send({error:"Parameter 'scope' not specified!"});let $=s.headers["g-recaptcha-response"];if($)try{if(!await Q($.toString(),"login"))return await t.sso.addAuthLog(null,!1,0,"Bot detected!",u,y,w),s.log.warn({username:r,reason:"Bot detected!"},"Failed to authenticate!"),e.code(403).send({error:"Bot detected!"})}catch(g){s.log.warn({username:r,reason:"Failed to verify reCAPTCHA!",err:g},"Failed to authenticate!")}let F=await t.sso.getFailedAuthAttempts(null,u);if(F.ip.length>=20)return await t.sso.addAuthLog(null,!1,3,"too many failed attempts",u,y,w),e.code(429).send({reason:"too many failed attempts"});let h=await t.sso.get(r);if(!h)return await t.sso.addAuthLog(null,!1,0,"wrong username",u,y,w),s.log.warn({username:r,reason:"wrong username"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});if(F=await t.sso.getFailedAuthAttempts(h.id.toString(),null),F.user.length>=10)return await t.sso.addAuthLog(h?.id.toString(),!1,2,"too many failed attempts",u,y,w),e.code(429).send({reason:"too many failed attempts"});if(!h.active)return await t.sso.addAuthLog(h?.id.toString(),!1,0,"user is inactive",u,y,w),s.log.warn({username:r},"Inactive user tried to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});if(!U.default.compareSync(o,h.password))if(o===h.password)await t.updatePassword(h.id.toString(),U.default.hashSync(o,Y.env.BCRYPT_COST??13));else return await t.sso.addAuthLog(h.id.toString(),!1,0,"wrong password",u,y,w),s.log.warn({username:r,reason:"wrong password"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});let O=[];if("password_policy"in V.default){let g=new S(o,V.default.password_policy);try{g.audit()}catch(I){O.push(I)}}let L,N;if(n===void 0){L=await t.sso.createAuthorizationCode(h.id.toString(),d);let g=new P(h,a,{authorization_code:L});g.challengeRequired()===!0&&(N=!0,await g.challenge())}else{let g=await t.sso.getMfaInfo(n);if(g){if(!g.used){let I=new P(h,a,g);I.complete(n)&&(await I.use(n),L=g.authorization_code)}}else return await t.sso.addAuthLog(h.id.toString(),!1,0,"mfa_info missing",u,y,w),s.log.warn({username:r,reason:"mfa_info not found"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"})}return{authorization_code:N===void 0?L:void 0,mfa_required:N,errors:O}}catch(t){throw t}};var Z=async(s,e)=>{let t=new _;try{let r=s.query.grant_type,o=s.query.code;if(r!=="authorization_code")return e.code(400).send({error:"Invalid 'grant_type' specified!"});if(!o)return e.code(400).send({error:"No 'code' supplied!"});let n=await t.sso.getAuthorizationCode(o);if(!n)return e.code(404).send({error:"Invalid 'code' specified!"});if(n.expires<new Date)return e.code(403).send({error:"'code' has expired!"});let c=await t.getAccessToken(n),d=await t.getIdToken(n),a={access_token:c,token_type:"Bearer",expires_in:900,id_token:d};try{n.scope.indexOf("offline_access")!==-1&&(a={...a,refresh_token:await t.getRefreshToken(n.user_id,o,c.split(".")[2])})}catch(u){s.log.warn({error:u,authorizationCode:s.query.code,grantType:s.query.grant_type,redirectUri:s.query.redirect_uri},"Couldn't create refresh token, something unexpected happened")}return a}catch(r){return console.error(r),s.log.error({error:r,authorizationCode:s.query.code,grantType:s.query.grant_type,redirectUri:s.query.redirect_uri},"Couldn't retrieve token, something unexpected happened"),e.code(500).send({error:"Something unexpected happened!"})}};var ee=p(require("bcrypt")),te=require("process");var re=async(s,e)=>{},se=async(s,e)=>{try{let t=new _,r=s.query.token,o=await t.sso.getRefreshToken(r);if(!o)return e.code(403).send({error:"This refresh token does not exist!"});let n=await t.sso.getAuthorizationCode(o.authorization_code);if(!n)return;let c=await t.getAccessToken(n),d=await t.getIdToken(n),a={access_token:c,token_type:"Bearer",expires_in:900,id_token:d},u=await t.sso.updateRefreshToken(r);return u?{...a,refresh_token:u}:e.code(403).send({error:"This refresh token has been revoked/expired!"})}catch(t){throw t}},oe=async(s,e)=>{try{let t=new _,r=s.token||{sub:null};if(r.sub){let n=s.body.password;return n=ee.default.hashSync(n,te.env.BCRYPT_COST??13),await t.updatePassword(r.sub,n)}return}catch(t){throw t}};var ne=[{method:"POST",url:"/authorize",handler:X},{method:"GET",url:"/token",handler:Z},{method:"POST",url:"/users/refresh-token",handler:se},{method:"POST",url:"/users/revoke-token",handler:re},{method:"POST",url:"/users/update-password",handler:oe}];var Ee=async()=>{let s=new ae.default(de.default.wrapper);s.addAuthPreHandler(ce.default,"token"),s.routeMultiple(ne);let e=z.env.APP_VERSION?"/"+z.env.APP_VERSION:"";s.server.register(require("@fastify/static"),{root:ie.default.join(__dirname,".well-known"),prefix:e+"/sso/.well-known/"}),await s.start()};Ee();
