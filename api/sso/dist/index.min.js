var be=Object.create;var Q=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var Ce=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var Ae=(r,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of Re(e))!Ee.call(r,n)&&n!==t&&Q(r,n,{get:()=>e[n],enumerable:!(s=ke(e,n))||s.enumerable});return r};var g=(r,e,t)=>(t=r!=null?be(Ce(r)):{},Ae(e||!r||!r.__esModule?Q(t,"default",{value:r,enumerable:!0}):t,r));var me=g(require("path")),j=require("process"),we=g(require("@groupclaes/fastify-elastic")),_e=g(require("@groupclaes/fastify-authhandler")),ye=g(require("./config"));var B=g(require("bcrypt")),ie=require("process"),H=g(require("./config"));var p=g(require("mssql")),E=g(require("jose"));var J=require("mssql"),W=require("./config"),P=new Map,l={get:async r=>{if(!P.has(r)){if(!W.mssql[r])throw new Error(`Configuration for pool '${r}' does not exist!`);let e=new J.ConnectionPool(W.mssql[r]),t=e.close.bind(e);e.close=(...s)=>(P.delete(r),t(...s)),P.set(r,await e.connect())}return P.get(r)},closeAll:()=>Promise.all(Array.from(P.values()).map(r=>r.then(e=>e.close())))};var y=g(require("./config"));var i=g(require("mssql"));var f="brabopak",F=class{constructor(){this.schema="[sso]"}async get(e){let t=new i.default.Request(await l.get(f));t.input("username",i.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getUser]`);if(s.recordset.length>0)return s.recordset[0]}async getUserInfo(e){let t=new i.default.Request(await l.get(f));t.input("user_id",i.default.Int,e);let s=await t.execute(`${this.schema}.[usp_getUserInfo]`);if(s.recordset.length>0)return s.recordset[0][0]}async updatePassword(e,t){let s=new i.default.Request(await l.get(f));s.input("user_id",i.default.Int,e),s.input("password",i.default.VarChar,t);let n=await s.execute(`${this.schema}.[usp_updateUserPassword]`);if(n.recordset.length>0)return n.rowsAffected[0]>0}async refreshTokenExists(e){let t=new i.default.Request(await l.get(f));t.input("token",i.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getTokenExists]`);if(s.recordset.length>0)return s.recordset[0].exists}async createAuthorizationCode(e,t,s){let n=new i.default.Request(await l.get(f));n.input("client_id",i.default.VarChar,e),n.input("user_id",i.default.Int,t),n.input("scope",i.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_createAuthorizationCode]`);if(o.recordset.length>0)return o.recordset[0].code}async getAuthorizationCode(e){let t=new i.default.Request(await l.get(f));t.input("code",i.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getAuthorizationCode]`);if(s.recordset.length>0)return s.recordset[0]}async createRefreshToken(e,t,s){let n=new i.default.Request(await l.get(f));n.input("user_id",i.default.Int,e),n.input("authorization_code",i.default.VarChar,t),n.input("access_token",i.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_createRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getRefreshToken(e){let t=new i.default.Request(await l.get(f));t.input("token",i.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_getRefreshToken]`);if(s.recordset.length>0)return s.recordset[0]}async updateRefreshToken(e){let t=new i.default.Request(await l.get(f));t.input("token",i.default.VarChar,e);let s=await t.execute(`${this.schema}.[usp_updateRefreshToken]`);if(s.recordset)return s.recordset[0].token}async revokeRefreshToken(e,t,s){let n=new i.default.Request(await l.get(f));n.input("token",i.default.VarChar,e),n.input("reason_revoked",i.default.VarChar,t),n.input("replaced_by_token",i.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_revokeRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getMfaInfo(e){let t=new i.default.Request(await l.get(f));t.input("mfa_code",i.default.VarChar,e);let s=await t.execute(`${this.schema}[usp_getMfaInfo]`);if(s.recordset.length>0)return s.recordset[0]}async addAuthLog(e,t=!1,s=0,n=null,o="127.0.0.1",u=50,c=null){let a=new i.default.Request(await l.get(f));e===void 0&&(e=null),a.input("user_id",i.default.Int,e),a.input("client_id",i.default.VarChar,"hBK4c2uZK5"),a.input("success",i.default.Bit,t),a.input("result",i.default.TinyInt,s),a.input("reason",i.default.VarChar,n),a.input("ip",i.default.VarChar,o),a.input("rating",i.default.TinyInt,u),a.input("user_agent",i.default.VarChar,c);let d=await a.execute(`${this.schema}.[usp_addAuthLog]`);if(d.rowsAffected.length>0)return d.rowsAffected[0]>0}async getFailedAuthAttempts(e=null,t=null){let s=new i.default.Request(await l.get(f));s.input("user_id",i.default.Int,e),s.input("ip",i.default.VarChar,t);let n=await s.execute(`${this.schema}.[usp_getFailedAuthAttempts]`);return n.recordsets.length>0?{user:n.recordsets[0]??[],ip:n.recordsets[1]??[]}:{user:[],ip:[]}}async createResetToken(e,t="127.0.0.1"){let s=new i.default.Request(await l.get(f));return s.input("user_id",i.default.Int,e),s.input("ip",i.default.VarChar,t),(await s.execute(`${this.schema}.[usp_createResetToken]`)).recordset[0]?.token}async revokeResetToken(e,t="127.0.0.1",s){let n=new i.default.Request(await l.get(f));n.input("token",i.default.VarChar,e),n.input("ip",i.default.VarChar,t),n.input("reason",i.default.VarChar,s);let o=await n.execute(`${this.schema}.[usp_revokeResetToken]`);return o.rowsAffected.length>0&&o.rowsAffected[0]>0}async getResetToken(e){let t=new i.default.Request(await l.get(f));return t.input("token",i.default.VarChar,e),(await t.execute(`${this.schema}.[usp_getResetToken]`)).recordset[0]?.user_id}};var K=900,z="brabopak",w=class{constructor(){this.schema="[sso]";this.updatePassword=(e,t)=>this.sso.updatePassword(e,t);this.getAudSub=e=>({audience:[process.env.CLIENT_ID??"unknown"],subject:e.toString()});this.sso=new F}async getIdToken(e){let{audience:t,subject:s}=this.getAudSub(e.user_id),n=await this.sso.getUserInfo(e.user_id),o,u=e.scope.split(" ");for(let[a,d]of Object.entries(n))o||(o={}),u.indexOf(a)!==-1&&(o[a]=d);if(!o)throw new Error("Invalid payload");let c=await E.importJWK(y.default.key);return await new E.SignJWT(o).setProtectedHeader({alg:y.default.key.alg,kid:y.default.key.kid,jku:y.default.key.iss}).setIssuer(y.default.key.iss).setAudience(t).setExpirationTime(K+"s").setSubject(s).sign(c)}async getAccessToken(e){let{audience:t,subject:s}=this.getAudSub(e.user_id),n=await E.importJWK(y.default.key);return await new E.SignJWT({}).setProtectedHeader({alg:y.default.key.alg,kid:y.default.key.kid,jku:y.default.key.iss}).setIssuer(y.default.key.iss).setAudience(t).setExpirationTime(K+"s").setSubject(s).sign(n)}getRefreshToken(e,t,s){return this.sso.createRefreshToken(e,t,s)}async create(e,t,s){let n=new p.default.Request(await l.get(z));return n.input("username",p.default.VarChar,e),n.input("password",p.default.VarChar,t),n.input("usercode",p.default.Int,s),(await n.execute(`${this.schema}.[usp_createUser]`)).rowsAffected[0]>0}async checkSettings(e){let t=new p.default.Request(await l.get(z));return t.input("usercode",p.default.Int,e.usercode),t.input("user_type",p.default.Int,e.user_type),t.input("customer_id",p.default.Int,e.customer_id),t.input("address_id",p.default.Int,e.address_id),t.input("group_id",p.default.Int,e.group_id),t.input("promo",p.default.Bit,e.promo),t.input("bonus_percentage",p.default.Numeric,e.bonus_percentage),t.input("fostplus",p.default.Bit,e.fostplus),t.input("customer_type",p.default.TinyInt,e.customer_type),t.input("price_class",p.default.Int,e.price_class),(await t.execute(`${this.schema}.[usp_createOrUpdateSettings]`)).rowsAffected[0]>0}async getCustomers(e){let t=new p.default.Request(await l.get(z));t.input("user_id",p.default.Int,e);let s=await t.execute(`${this.schema}.[usp_getCustomers]`);if(s.recordset.length>0)return s.recordset[0]}};var Y=g(require("https")),Z=require("process");async function X(r,e){return new Promise((t,s)=>{let n=Y.default.request(`https://www.google.com/recaptcha/api/siteverify?secret=${Z.env.GOOGLE_API}&response=${r}`,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"}},o=>{let u="";o.on("data",c=>{u+=c}),o.on("end",c=>{let a=u&&typeof u=="string"?JSON.parse(u):u;if(u=null,!a){s("Could not verify reCAPTCHA!");return}e&&a.action!==e&&s("Actions do not match!"),a["error-codes"]&&a["error-codes"].length>0&&s(a["error-codes"]),t(a.success)}),o.on("error",c=>{s(c)})});n.on("error",o=>{s(o)}),n.end()})}var U=class{constructor(e,t){this._minLength=8;this._maxLength=128;this._requireLowercase=!1;this._requireUppercase=!1;this._requireDigits=!1;this._password=e,t&&(this._minLength=t.min_length||this._minLength,this._maxLength=t.max_length||this._maxLength,this._requireLowercase=t.require_digits||this._requireLowercase,this._requireUppercase=t.require_uppercase||this._requireUppercase,this._requireDigits=t.require_lowercase||this._requireDigits)}audit(){if(this._password.length<this._minLength)throw this.resolveError(I.E_MIN_LENGTH);if(this._password.length>this._maxLength)throw this.resolveError(I.E_MAX_LENGTH);if(this._requireDigits&&this._password.split("").some(e=>e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57))throw this.resolveError(I.E_REQUIRE_DIGITS);if(this._requireUppercase&&this._password.split("").some(e=>e.charCodeAt(0)>=65&&e.charCodeAt(0)<=90))throw this.resolveError(I.E_REQUIRE_UPPERCASE);if(this._requireLowercase&&this._password.split("").some(e=>e.charCodeAt(0)>=97&&e.charCodeAt(0)<=122))throw this.resolveError(I.E_REQUIRE_LOWECASE);return!0}resolveError(e){switch(e){case 0:return new k(e,`Password length must be at least ${this._minLength} characters long.`,{length:this._minLength});case 1:return new k(e,`Password length must be at most ${this._maxLength} characters long.`,{length:this._maxLength});case 2:return new k(e,"Password must contain at least one digit.");case 3:return new k(e,"Password must contain at least one uppercase character.");case 4:return new k(e,"Password must contain at least one lowercase character.")}return new Error("Unexpected error")}},I={E_MIN_LENGTH:0,E_MAX_LENGTH:1,E_REQUIRE_DIGITS:2,E_REQUIRE_UPPERCASE:3,E_REQUIRE_LOWECASE:4},k=class extends Error{constructor(t,s,n){super(s);this.error="PasswordPolicy";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var R=g(require("mssql")),te=g(require("nodemailer")),re=g(require("fs")),se=g(require("crypto"));var ee="brabopak",S=class{constructor(e,t,s){this._user=e,this._client_id=t,this._info=s}challengeRequired(){return!1}async challenge(e="nl"){if(!this._user.email)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let t=Te(),s=new R.default.Request(await l.get(ee));if(s.input("mfa_code",R.default.VarChar,t),s.input("user_id",R.default.Int,this._user.id),s.input("authorization_code",R.default.VarChar,this._info.authorization_code),(await s.query("INSERT INTO [sso].[mfaCodes] (code, userId, authorizationCode) VALUES (@mfa_code, @user_id, @authorization_code)")).rowsAffected[0]<=0)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let o=te.default.createTransport({host:"debian-smtp.groupclaes.be",port:25,secure:!1}),u=e==="nl"?"Meervoudige authenticatie":"Authentification multiple",c=re.default.readFileSync(`./templates/template_${e}.html`).toString("utf-8"),a='<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#ffffff" align="center" style="padding:30px 30px 40px"><table border="0" cellspacing="0" cellpadding="0"><tr><td align="center" style="border-radius:3px;" bgcolor="#40ab86"><span style="pointer-events:none;font-size:20px;font-family:Helvetica,Arial,sans-serif;color:#ffffff;text-decoration:none;color:#ffffff;text-decoration:none;padding:15px 25px;border-radius:2px;border:1px solid #24704C;display:inline-block;">@Button.Text</span></td></tr></table></td></tr></table>';c=c.replace("@RenderTitle()",u);let d="Geef onderstaande code in om toegang te krijgen tot de applicatie.";a=a.replace("@Button.Text",t);let C='Als je vragen hebt of om welke reden dan ook hulp nodig hebt, neem dan contact op met ons via <a href="mailto:it@groupclaes.be" style="color:#40ab86;text-decoration:underline;">it@groupclaes.be</a>.<br><br>Met vriendelijke groeten<br>Het ICT Team van Group Claes';c=c.replace("@RenderHeader()",u+" \u2714"),c=c.replace("@RenderBody()",d+a+C),await o.sendMail({from:'"Brabopak - webshop"<bestel@brabopak.com>',to:this._user.email,subject:u,text:u,html:c})}complete(e){if(e.length!==8)throw this.resolveError(q.E_INVALLID_CHALLENGE);if(this._info.code===e&&this._info.user_id===this._user.id)return!0;throw this.resolveError(q.E_CHALLENGE_FAILED)}async use(e){let t=new R.default.Request(await l.get(ee));return t.input("mfa_code",R.default.VarChar,e),(await t.query("UPDATE [sso].[mfaCodes] SET used = CAST(1 AS BIT) WHERE code = @mfa_code")).rowsAffected[0]>0}resolveError(e){switch(e){case 0:return new A(e,"Failed to send challenge.");case 1:return new A(e,"Challenge already send.");case 2:return new A(e,"Challenge failed.");case 3:return new A(e,"Invallid challenge.")}return new Error("Unexpected error")}},q={E_CHALLENGE_NOT_SEND:0,E_CHALLENGE_ALREADY_SEND:1,E_CHALLENGE_FAILED:2,E_INVALLID_CHALLENGE:3},Te=()=>{let r="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";se.default.getRandomValues(new Uint32Array(e.length));for(let t=0;t<8;t++)r+=e.charAt(Math.floor(xe()*e.length));return r},xe=function(){return window.crypto.getRandomValues(new Uint32Array(1))[0]/2**32},A=class extends Error{constructor(t,s,n){super(s);this.error="MFA";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var Pe=new RegExp(/^((?<username>vangeyja|minnengu|nijsthib)(\$\$))*(?<email>[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)/g);function ne(r){return r?!r.includes("Mozilla")&&!r.includes("Chrome")&&!r.includes("Safari")?20:50:0}function oe(r){let e=Pe.exec(r);if(!e?.groups?.username)return;let t=e.groups.email;switch(e.groups.username){case"vangeyja":r="jamie.vangeysel@groupclaes.be";break;case"minnengu":r="guy.minnen@groupclaes.be";break;case"nijsthib":r="thibaut.nijs@groupclaes.be";break}return{username:r,impersonated_user:t}}var ae=async(r,e)=>{try{let t=new w,s,n=r.body.username.toLowerCase(),o=r.body.password,u="127.0.0.1",c=r.headers["x-client-ip"];typeof c=="string"?u=c.split(",")[0]:c&&(u=c[0].split(",")[0]);let a=r.headers["user-agent"],d=ne(a);if(!r.query.response_type)return N(r,e,"parameter 'response_type' not specified!");if(r.query.response_type!=="code")return N(r,e,"invalid 'response_type' specified!");if(!r.query.scope)return N(r,e,"parameter 'scope' not specified!");if(!r.query.client_id)return N(r,e,"parameter 'client_id' not specified!");let C=r.headers["g-recaptcha-response"];if(C)try{if(!await X(C.toString(),"login"))return await b(r,e,t,403,"Bot detected!",n,null,!1,0,"Bot detected!",u,d,a)}catch(_){r.log.warn({username:n,reason:"Failed to verify reCAPTCHA!",err:_},"Failed to authenticate!")}else return await b(r,e,t,403,"No reCAPTCHA challenge!",n,null,!1,0,"No reCAPTCHA challenge!",u,d,a);let T=oe(n);T&&(n=T.username,s=T.impersonated_user);let x=await t.sso.getFailedAuthAttempts(null,u);if(x.ip.length>=20)return await b(r,e,t,429,"too many failed attempts",n,null,!1,3,"too many failed attempts",u,d,a);let m=await t.sso.get(n);if(!m)return await b(r,e,t,404,"Username or password is incorrect!",n,null,!1,0,"wrong username",u,d,a);if(x=await t.sso.getFailedAuthAttempts(m.id.toString(),null),x.user.length>=10)return await b(r,e,t,429,"too many failed attempts",n,m.id.toString(),!1,2,"too many failed attempts",u,d,a);if(!m.active)return await b(r,e,t,404,"Username or password is incorrect!",n,m.id.toString(),!1,0,"user is inactive",u,d,a);if(!B.default.compareSync(o,m.password))if(o===m.password)await t.updatePassword(m.id.toString(),B.default.hashSync(o,+(ie.env.BCRYPT_COST??13)));else return await b(r,e,t,404,"Username or password is incorrect!",n,m.id.toString(),!1,0,"wrong password",u,d,a);let G=[];if("password_policy"in H.default){let _=new U(o,H.default.password_policy);try{_.audit()}catch(L){G.push(L)}}let M;s!==void 0&&(M=await t.sso.get(s));let v,O;if(r.body.mfa_code===void 0){v=await t.sso.createAuthorizationCode(r.query.client_id,M??m.id.toString(),r.query.scope);let _=new S(m,r.query.client_id,{authorization_code:v});_.challengeRequired()===!0&&(O=!0,await _.challenge())}else{let _=await t.sso.getMfaInfo(r.body.mfa_code);if(_){if(!_.used){let L=new S(m,r.query.client_id,_);L.complete(r.body.mfa_code)&&(await L.use(r.body.mfa_code),v=_.authorization_code)}}else return await b(r,e,t,404,"Username or password is incorrect!",n,m.id.toString(),!1,0,"mfa_info missing",u,d,a)}return{authorization_code:O===void 0?v:void 0,mfa_required:O,errors:G}}catch(t){throw t}};function N(r,e,t){return r.log.warn(t),e.code(400).send({error:t})}async function b(r,e,t,s,n,o,u,c=!1,a=0,d=null,C="127.0.0.1",T=50,x=null){return await t.sso.addAuthLog(u,c,a,d,C,T,x),r.log.warn({username:o,reason:d},"Failed to authenticate!"),e.code(s).send({error:n})}var ue=async(r,e)=>{let t=new w;try{let s=r.query.grant_type,n=r.query.code;if(s!=="authorization_code")return r.log.warn("Invalid 'grant_type' specified!"),e.code(400).send({status:"error",code:400,message:"Invalid 'grant_type' specified!"});if(!n)return r.log.warn("Parameter 'code' not specified!"),e.code(400).send({status:"error",code:400,message:"No 'code' supplied!"});let o=await t.sso.getAuthorizationCode(n);if(!o)return r.log.warn("Invalid 'code' specified!"),e.code(404).send({status:"error",code:404,message:"Invalid 'code' specified!"});if(o.expires<new Date)return r.log.warn("'code' has expired!"),e.code(403).send({status:"error",code:403,message:"'code' has expired!"});let u=await t.getAccessToken(o),c=await t.getIdToken(o),a={access_token:u,token_type:"Bearer",expires_in:900,id_token:c};try{o.scope.indexOf("offline_access")!==-1&&(a={...a,refresh_token:await t.getRefreshToken(o.user_id,n,u.split(".")[2])})}catch(d){r.log.warn({error:d,authorizationCode:r.query.code,grantType:r.query.grant_type,redirectUri:r.query.redirect_uri},"Couldn't create refresh token, something unexpected happened")}return a}catch(s){return r.log.error({error:s,authorizationCode:r.query.code,grantType:r.query.grant_type,redirectUri:r.query.redirect_uri},"Couldn't retrieve token, something unexpected happened"),e.code(500).send({status:"error",code:500,message:"Something unexpected happened!"})}};var V=g(require("bcrypt")),$=require("process"),h=require("@groupclaes/fastify-elastic/responses"),D=g(require("@groupclaes/oe-connector"));var ce=async(r,e)=>{try{let t=new w,{username:s,password:n,code:o}=r.body;if(D.default.configure({c:!1}),await t.sso.get(s))return r.log.warn({username:s,code:o,reason:"user already exists"},"Failed to register!"),e.status(403).send({status:"fail",code:403,message:"user already exists"});let c=await D.default.run("signon",[s,o,"BRA",void 0],{tw:-1,simpleParameters:!0});if(c&&c.status===200&&c.result){let a=c.result.settings;if(a&&a.length>0){let d=a[0];return await t.create(s,V.default.hashSync(n,+($.env.BCRYPT_COST??13)),d.usercode)?(await t.checkSettings(d),r.log.debug({username:s,code:o},"User successfully registered!"),{status:"success",code:200,data:{success:!0}}):(r.log.debug({username:s,code:o,reason:"error while creating new user entry"},"Failed to register user!"),e.status(500).send({status:"error",code:500,message:"error while creating new user entry"}))}return r.log.debug({username:s,code:o,reason:"error with usersettings!"},"Failed to register user!"),e.status(500).send({status:"error",code:500,message:"error with usersettings!"})}else return r.log.debug({username:s,code:o,reason:"error while retrieving registration info!"},"Failed to register user!"),e.status(500).send({status:"error",code:500,message:"error while retrieving registration info!"})}catch(t){return r.log.debug({reason:"unknown error",err:t},"Failed to register user!"),(0,h.error)(e,"failed to register user")}},de=async(r,e)=>(0,h.fail)(e,{reason:"Method not implemented"}),le=async(r,e)=>{try{let t=new w,s=r.query.token,n=await t.sso.getRefreshToken(s);if(!n)return e.code(403).send({error:"This refresh token does not exist!"});let o=await t.sso.getAuthorizationCode(n.authorization_code);if(!o)return;let u=await t.getAccessToken(o),c=await t.getIdToken(o),a={access_token:u,token_type:"Bearer",expires_in:900,id_token:c},d=await t.sso.updateRefreshToken(s);return d?{...a,refresh_token:d}:e.code(403).send({error:"This refresh token has been revoked/expired!"})}catch(t){throw t}},pe=async(r,e)=>{try{let t=new w,s=r.token||{sub:null};if(s.sub){let o=r.body.password;return o=V.default.hashSync(o,+($.env.BCRYPT_COST??13)),await t.updatePassword(s.sub,o)}return}catch(t){return r.log.error({err:t},"error while updating password"),(0,h.error)(e,"error while updating password")}},ge=async(r,e)=>{let t="127.0.0.1",s=r.headers["x-client-ip"];typeof s=="string"?t=s.split(",")[0]:s&&(t=s[0].split(",")[0]);try{let n=new w,o=await n.sso.get(r.body.username);if(!o?.active)return(0,h.fail)(e,{username:"account not found!"});if(r.query.reset_token){let u=await n.sso.getResetToken(r.query.reset_token);if(!u)return(0,h.fail)(e,{reset_token:"token not found!"});if(!r.body.password)return(0,h.fail)(e,{password:"missing in payload"});let c=V.default.hashSync(r.body.password,+($.env.BCRYPT_COST??13));return await n.updatePassword(u,c)?(await n.sso.revokeResetToken(r.query.reset_token,t,"used"),(0,h.success)(e,{success:!0})):(0,h.error)(e,"failed to update password in db")}else{let u=await n.sso.createResetToken(o.id.toString(),t);return u?(0,h.success)(e,{success:!0,token:u}):(0,h.error)(e,"error creating new reset token")}}catch(n){return r.log.error({err:n},"error while requesting password reset"),(0,h.error)(e,"error while requesting password reset")}},fe=async(r,e)=>{try{let t=new w,s=r.token||{sub:null};return s.sub?await t.getCustomers(s.sub):e.status(401).send({status:"fail",code:401,message:"Unauthorized"})}catch(t){return e.status(500).send(t)}};var he=[{method:"POST",url:"/authorize",handler:ae},{method:"GET",url:"/token",handler:ue},{method:"GET",url:"/users/customers",handler:fe,requiredPermissions:[]},{method:"POST",url:"/users/signon",handler:ce},{method:"POST",url:"/users/refresh-token",handler:le},{method:"POST",url:"/users/revoke-token",handler:de},{method:"POST",url:"/users/update-password",handler:pe},{method:"POST",url:"/users/reset-password",handler:ge}];var Le=async()=>{let r=new we.default(ye.default.wrapper);r.addAuthPreHandler(_e.default,"token"),r.routeMultiple(he);let e=j.env.APP_VERSION?"/"+j.env.APP_VERSION:"";r.server.register(require("@fastify/static"),{root:me.default.join(__dirname,".well-known"),prefix:e+"/sso/.well-known/"}),await r.start()};Le();
