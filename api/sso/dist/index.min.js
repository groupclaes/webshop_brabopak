var he=Object.create;var G=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var ge=Object.getOwnPropertyNames;var me=Object.getPrototypeOf,_e=Object.prototype.hasOwnProperty;var we=(s,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of ge(e))!_e.call(s,n)&&n!==t&&G(s,n,{get:()=>e[n],enumerable:!(r=fe(e,n))||r.enumerable});return s};var p=(s,e,t)=>(t=s!=null?he(me(s)):{},we(e||!s||!s.__esModule?G(t,"default",{value:s,enumerable:!0}):t,s));var ce=p(require("path")),z=require("process"),de=p(require("@groupclaes/fastify-elastic")),le=p(require("@groupclaes/fastify-authhandler")),pe=p(require("./config"));var N=p(require("bcrypt")),te=require("process"),V=p(require("./config"));var h=p(require("mssql")),C=p(require("jose"));var j=require("mssql"),M=require("./config"),x=new Map,l={get:async s=>{if(!x.has(s)){if(!M.mssql[s])throw new Error(`Configuration for pool '${s}' does not exist!`);let e=new j.ConnectionPool(M.mssql[s]),t=e.close.bind(e);e.close=(...r)=>(x.delete(s),t(...r)),x.set(s,await e.connect())}return x.get(s)},closeAll:()=>Promise.all(Array.from(x.values()).map(s=>s.then(e=>e.close())))};var w=p(require("./config"));var i=p(require("mssql"));var g="brabopak",L=class{constructor(){this.schema="[sso]"}async get(e){let t=new i.default.Request(await l.get(g));t.input("username",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getUser]`);if(r.recordset.length>0)return r.recordset[0]}async getUserInfo(e){let t=new i.default.Request(await l.get(g));t.input("user_id",i.default.Int,e);let r=await t.execute(`${this.schema}.[usp_getUserInfo]`);if(r.recordset.length>0)return r.recordset[0]}async updatePassword(e,t){let r=new i.default.Request(await l.get(g));r.input("user_id",i.default.Int,e),r.input("password",i.default.VarChar,t);let n=await r.execute(`${this.schema}.[usp_updateUserPassword]`);if(n.recordset.length>0)return n.rowsAffected[0]>0}async refreshTokenExists(e){let t=new i.default.Request(await l.get(g));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getTokenExists]`);if(r.recordset.length>0)return r.recordset[0].exists}async createAuthorizationCode(e,t,r){let n=new i.default.Request(await l.get(g));n.input("client_id",i.default.VarChar,e),n.input("user_id",i.default.Int,t),n.input("scope",i.default.VarChar,r);let o=await n.execute(`${this.schema}.[usp_createAuthorizationCode]`);if(o.recordset.length>0)return o.recordset[0].code}async getAuthorizationCode(e){let t=new i.default.Request(await l.get(g));t.input("code",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getAuthorizationCode]`);if(r.recordset.length>0)return r.recordset[0]}async createRefreshToken(e,t,r){let n=new i.default.Request(await l.get(g));n.input("user_id",i.default.Int,e),n.input("authorization_code",i.default.VarChar,t),n.input("access_token",i.default.VarChar,r);let o=await n.execute(`${this.schema}.[usp_createRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getRefreshToken(e){let t=new i.default.Request(await l.get(g));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_getRefreshToken]`);if(r.recordset.length>0)return r.recordset[0]}async updateRefreshToken(e){let t=new i.default.Request(await l.get(g));t.input("token",i.default.VarChar,e);let r=await t.execute(`${this.schema}.[usp_updateRefreshToken]`);if(r.recordset)return r.recordset[0].token}async revokeRefreshToken(e,t,r){let n=new i.default.Request(await l.get(g));n.input("token",i.default.VarChar,e),n.input("reason_revoked",i.default.VarChar,t),n.input("replaced_by_token",i.default.VarChar,r);let o=await n.execute(`${this.schema}.[usp_revokeRefreshToken]`);if(o.recordset.length>0)return o.recordset[0].token}async getMfaInfo(e){let t=new i.default.Request(await l.get(g));t.input("mfa_code",i.default.VarChar,e);let r=await t.execute(`${this.schema}[usp_getMfaInfo]`);if(r.recordset.length>0)return r.recordset[0]}async addAuthLog(e,t=!1,r=0,n=null,o="127.0.0.1",u=50,c=null){let a=new i.default.Request(await l.get(g));e===void 0&&(e=null),a.input("user_id",i.default.Int,e),a.input("client_id",i.default.VarChar,"hBK4c2uZK5"),a.input("success",i.default.Bit,t),a.input("result",i.default.TinyInt,r),a.input("reason",i.default.VarChar,n),a.input("ip",i.default.VarChar,o),a.input("rating",i.default.TinyInt,u),a.input("user_agent",i.default.VarChar,c);let d=await a.execute(`${this.schema}.[usp_addAuthLog]`);if(d.rowsAffected.length>0)return d.rowsAffected[0]>0}async getFailedAuthAttempts(e=null,t=null){let r=new i.default.Request(await l.get(g));r.input("user_id",i.default.Int,e),r.input("ip",i.default.VarChar,t);let n=await r.execute(`${this.schema}.[usp_getFailedAuthAttempts]`);return n.recordsets.length>0?{user:n.recordsets[0]??[],ip:n.recordsets[1]??[]}:{user:[],ip:[]}}};var Q=900,W="brabopak",y=class{constructor(){this.schema="[sso]";this.updatePassword=(e,t)=>this.sso.updatePassword(e,t);this.getAudSub=e=>({audience:[process.env.CLIENT_ID],subject:e.toString()});this.sso=new L}async getIdToken(e){let{audience:t,subject:r}=this.getAudSub(e.user_id),n=await this.sso.getUserInfo(e.user_id),o,u=e.scope.split(" ");for(let[a,d]of Object.entries(n))o||(o={}),u.indexOf(a)!==-1&&(o[a]=d);if(!o)throw new Error("Invalid payload");let c=await C.importJWK(w.default.key);return await new C.SignJWT(o).setProtectedHeader({alg:w.default.key.alg,kid:w.default.key.kid,jku:w.default.key.iss}).setIssuer(w.default.key.iss).setAudience(t).setExpirationTime(Q+"s").setSubject(r).sign(c)}async getAccessToken(e){let{audience:t,subject:r}=this.getAudSub(e.user_id),n=await C.importJWK(w.default.key);return await new C.SignJWT({}).setProtectedHeader({alg:w.default.key.alg,kid:w.default.key.kid,jku:w.default.key.iss}).setIssuer(w.default.key.iss).setAudience(t).setExpirationTime(Q+"s").setSubject(r).sign(n)}getRefreshToken(e,t,r){return this.sso.createRefreshToken(e,t,r)}async create(e,t,r){let n=new h.default.Request(await l.get(W));return n.input("username",h.default.VarChar,e),n.input("password",h.default.VarChar,t),n.input("usercode",h.default.Int,r),(await n.execute(`${this.schema}.[usp_createUser]`)).rowsAffected[0]>0}async checkSettings(e){let t=new h.default.Request(await l.get(W));return t.input("usercode",h.default.Int,e.usercode),t.input("user_type",h.default.Int,e.user_type),t.input("customer_id",h.default.Int,e.customer_id),t.input("address_id",h.default.Int,e.address_id),t.input("group_id",h.default.Int,e.group_id),t.input("promo",h.default.Bit,e.promo),t.input("bonus_percentage",h.default.Numeric,e.bonus_percentage),t.input("fostplus",h.default.Bit,e.fostplus),t.input("customer_type",h.default.VarChar,e.customer_type),t.input("price_class",h.default.Int,e.price_class),(await t.execute(`${this.schema}.[usp_createOrUpdateSettings]`)).rowsAffected[0]>0}};var J=p(require("https")),K=require("process");async function Y(s,e){return new Promise((t,r)=>{let n=J.default.request(`https://www.google.com/recaptcha/api/siteverify?secret=${K.env.GOOGLE_API}&response=${s}`,{method:"POST",headers:{"Content-Type":"application/json; charset=utf-8"}},o=>{let u="";o.on("data",c=>{u+=c}),o.on("end",c=>{let a=u&&typeof u=="string"?JSON.parse(u):u;if(u=null,!a){r("Could not verify reCAPTCHA!");return}e&&a.action!==e&&r("Actions do not match!"),a["error-codes"]&&a["error-codes"].length>0&&r(a["error-codes"]),t(a.success)}),o.on("error",c=>{r(c)})});n.on("error",o=>{r(o)}),n.end()})}var v=class{constructor(e,t){this._minLength=8;this._maxLength=128;this._requireLowercase=!1;this._requireUppercase=!1;this._requireDigits=!1;this._password=e,t&&(this._minLength=t.min_length||this._minLength,this._maxLength=t.max_length||this._maxLength,this._requireLowercase=t.require_digits||this._requireLowercase,this._requireUppercase=t.require_uppercase||this._requireUppercase,this._requireDigits=t.require_lowercase||this._requireDigits)}audit(){if(this._password.length<this._minLength)throw this.resolveError(T.E_MIN_LENGTH);if(this._password.length>this._maxLength)throw this.resolveError(T.E_MAX_LENGTH);if(this._requireDigits&&this._password.split("").some(e=>e.charCodeAt(0)>=48&&e.charCodeAt(0)<=57))throw this.resolveError(T.E_REQUIRE_DIGITS);if(this._requireUppercase&&this._password.split("").some(e=>e.charCodeAt(0)>=65&&e.charCodeAt(0)<=90))throw this.resolveError(T.E_REQUIRE_UPPERCASE);if(this._requireLowercase&&this._password.split("").some(e=>e.charCodeAt(0)>=97&&e.charCodeAt(0)<=122))throw this.resolveError(T.E_REQUIRE_LOWECASE);return!0}resolveError(e){switch(e){case 0:return new b(e,`Password length must be at least ${this._minLength} characters long.`,{length:this._minLength});case 1:return new b(e,`Password length must be at most ${this._maxLength} characters long.`,{length:this._maxLength});case 2:return new b(e,"Password must contain at least one digit.");case 3:return new b(e,"Password must contain at least one uppercase character.");case 4:return new b(e,"Password must contain at least one lowercase character.")}return new Error("Unexpected error")}},T={E_MIN_LENGTH:0,E_MAX_LENGTH:1,E_REQUIRE_DIGITS:2,E_REQUIRE_UPPERCASE:3,E_REQUIRE_LOWECASE:4},b=class extends Error{constructor(t,r,n){super(r);this.error="PasswordPolicy";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var k=p(require("mssql")),Z=p(require("nodemailer")),ee=p(require("fs"));var X="brabopak",I=class{constructor(e,t,r){this._user=e,this._client_id=t,this._info=r}challengeRequired(){return!1}async challenge(e="nl"){if(!this._user.email)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let t=ye(),r=new k.default.Request(await l.get(X));if(r.input("mfa_code",k.default.VarChar,t),r.input("user_id",k.default.Int,this._user.id),r.input("authorization_code",k.default.VarChar,this._info.authorization_code),(await r.query("INSERT INTO [sso].[mfaCodes] (code, userId, authorizationCode) VALUES (@mfa_code, @user_id, @authorization_code)")).rowsAffected[0]<=0)throw this.resolveError(q.E_CHALLENGE_NOT_SEND);let o=Z.default.createTransport({host:"debian-smtp.groupclaes.be",port:25,secure:!1}),u=e==="nl"?"Meervoudige authenticatie":"Authentification multiple",c=ee.default.readFileSync(`./templates/template_${e}.html`).toString("utf-8"),a='<table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td bgcolor="#ffffff" align="center" style="padding:30px 30px 40px"><table border="0" cellspacing="0" cellpadding="0"><tr><td align="center" style="border-radius:3px;" bgcolor="#40ab86"><span style="pointer-events:none;font-size:20px;font-family:Helvetica,Arial,sans-serif;color:#ffffff;text-decoration:none;color:#ffffff;text-decoration:none;padding:15px 25px;border-radius:2px;border:1px solid #24704C;display:inline-block;">@Button.Text</span></td></tr></table></td></tr></table>';c=c.replace("@RenderTitle()",u);let d="Geef onderstaande code in om toegang te krijgen tot de applicatie.";a=a.replace("@Button.Text",t);let A='Als je vragen hebt of om welke reden dan ook hulp nodig hebt, neem dan contact op met ons via <a href="mailto:it@groupclaes.be" style="color:#40ab86;text-decoration:underline;">it@groupclaes.be</a>.<br><br>Met vriendelijke groeten<br>Het ICT Team van Group Claes';c=c.replace("@RenderHeader()",u+" \u2714"),c=c.replace("@RenderBody()",d+a+A),await o.sendMail({from:'"Brabopak - webshop"<bestel@brabopak.com>',to:this._user.email,subject:u,text:u,html:c})}complete(e){if(e.length!==8)throw this.resolveError(q.E_INVALLID_CHALLENGE);if(this._info.code===e&&this._info.user_id===this._user.id)return!0;throw this.resolveError(q.E_CHALLENGE_FAILED)}async use(e){let t=new k.default.Request(await l.get(X));return t.input("mfa_code",k.default.VarChar,e),(await t.query("UPDATE [sso].[mfaCodes] SET used = CAST(1 AS BIT) WHERE code = @mfa_code")).rowsAffected[0]>0}resolveError(e){switch(e){case 0:return new R(e,"Failed to send challenge.");case 1:return new R(e,"Challenge already send.");case 2:return new R(e,"Challenge failed.");case 3:return new R(e,"Invallid challenge.")}return new Error("Unexpected error")}},q={E_CHALLENGE_NOT_SEND:0,E_CHALLENGE_ALREADY_SEND:1,E_CHALLENGE_FAILED:2,E_INVALLID_CHALLENGE:3},ye=()=>{for(var s="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",t=e.length,r=0;r<8;r++)s+=e.charAt(Math.floor(Math.random()*t));return s},R=class extends Error{constructor(t,r,n){super(r);this.error="MFA";this.toString=()=>`[${this.error_code}]: ${this.message}`;this.error_code=t,n&&(this.args=n)}};var re=async(s,e)=>{try{let t=new y,r=s.body.username,n=s.body.password,o=s.body.mfa_code,u=s.query.response_type,c=s.query.scope,a=s.query.client_id,d="127.0.0.1",A=s.headers["x-client-ip"];typeof A=="string"?d=A.split(",")[0]:A&&(d=A[0].split(",")[0]);let _=s.headers["user-agent"],E=50;if(_&&!_.includes("Mozilla")&&!_.includes("Chrome")&&!_.includes("Safari")&&(E=20),u!=="code")return e.code(400).send({error:"Invalid 'response_type' specified!"});if(!c)return e.code(400).send({error:"Parameter 'scope' not specified!"});let D=s.headers["g-recaptcha-response"];if(D)try{if(!await Y(D.toString(),"login"))return await t.sso.addAuthLog(null,!1,0,"Bot detected!",d,E,_),s.log.warn({username:r,reason:"Bot detected!"},"Failed to authenticate!"),e.code(403).send({error:"Bot detected!"})}catch(m){s.log.warn({username:r,reason:"Failed to verify reCAPTCHA!",err:m},"Failed to authenticate!")}let U=await t.sso.getFailedAuthAttempts(null,d);if(U.ip.length>=20)return await t.sso.addAuthLog(null,!1,3,"too many failed attempts",d,E,_),e.code(429).send({reason:"too many failed attempts"});let f=await t.sso.get(r);if(!f)return await t.sso.addAuthLog(null,!1,0,"wrong username",d,E,_),s.log.warn({username:r,reason:"wrong username"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});if(U=await t.sso.getFailedAuthAttempts(f.id.toString(),null),U.user.length>=10)return await t.sso.addAuthLog(f?.id.toString(),!1,2,"too many failed attempts",d,E,_),e.code(429).send({reason:"too many failed attempts"});if(!f.active)return await t.sso.addAuthLog(f?.id.toString(),!1,0,"user is inactive",d,E,_),s.log.warn({username:r},"Inactive user tried to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});if(!N.default.compareSync(n,f.password))if(n===f.password)await t.updatePassword(f.id.toString(),N.default.hashSync(n,+(te.env.BCRYPT_COST??13)));else return await t.sso.addAuthLog(f.id.toString(),!1,0,"wrong password",d,E,_),s.log.warn({username:r,reason:"wrong password"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"});let H=[];if("password_policy"in V.default){let m=new v(n,V.default.password_policy);try{m.audit()}catch(S){H.push(S)}}let P,F;if(o===void 0){P=await t.sso.createAuthorizationCode(a,f.id.toString(),c);let m=new I(f,a,{authorization_code:P});m.challengeRequired()===!0&&(F=!0,await m.challenge())}else{let m=await t.sso.getMfaInfo(o);if(m){if(!m.used){let S=new I(f,a,m);S.complete(o)&&(await S.use(o),P=m.authorization_code)}}else return await t.sso.addAuthLog(f.id.toString(),!1,0,"mfa_info missing",d,E,_),s.log.warn({username:r,reason:"mfa_info not found"},"Failed to authenticate!"),e.code(404).send({error:"Username or password is incorrect!"})}return{authorization_code:F===void 0?P:void 0,mfa_required:F,errors:H}}catch(t){throw t}};var se=async(s,e)=>{let t=new y;try{let r=s.query.grant_type,n=s.query.code;if(r!=="authorization_code")return e.code(400).send({error:"Invalid 'grant_type' specified!"});if(!n)return e.code(400).send({error:"No 'code' supplied!"});let o=await t.sso.getAuthorizationCode(n);if(!o)return e.code(404).send({error:"Invalid 'code' specified!"});if(o.expires<new Date)return e.code(403).send({error:"'code' has expired!"});let u=await t.getAccessToken(o),c=await t.getIdToken(o),a={access_token:u,token_type:"Bearer",expires_in:900,id_token:c};try{o.scope.indexOf("offline_access")!==-1&&(a={...a,refresh_token:await t.getRefreshToken(o.user_id,n,u.split(".")[2])})}catch(d){s.log.warn({error:d,authorizationCode:s.query.code,grantType:s.query.grant_type,redirectUri:s.query.redirect_uri},"Couldn't create refresh token, something unexpected happened")}return a}catch(r){return console.error(r),s.log.error({error:r,authorizationCode:s.query.code,grantType:s.query.grant_type,redirectUri:s.query.redirect_uri},"Couldn't retrieve token, something unexpected happened"),e.code(500).send({error:"Something unexpected happened!"})}};var B=p(require("bcrypt")),$=require("process"),O=p(require("@groupclaes/oe-connector"));var ne=async(s,e)=>{try{let t=new y,{username:r,password:n,code:o}=s.body;O.default.configure({c:!1});let u=await O.default.run("signon",[r,o,"BRA",void 0],{tw:-1,simpleParameters:!0});if(u&&u.status===200&&u.result){let c=u.result.settings;if(c&&c.length>0){let a=c[0];return await t.create(r,B.default.hashSync(n,+($.env.BCRYPT_COST??13)),a.usercode)?(await t.checkSettings(a),{success:!0}):e.status(500).send({status:"Internal Server Error",statusCode:500,message:"Error while creating new user entry!"})}return e.status(500).send({status:"Internal Server Error",statusCode:500,message:"Error with usersettings!"})}else return e.status(500).send({status:"Internal Server Error",statusCode:500,message:"Error while retrieving registration info!"})}catch(t){return e.status(500).send(t)}},oe=async(s,e)=>{},ie=async(s,e)=>{try{let t=new y,r=s.query.token,n=await t.sso.getRefreshToken(r);if(!n)return e.code(403).send({error:"This refresh token does not exist!"});let o=await t.sso.getAuthorizationCode(n.authorization_code);if(!o)return;let u=await t.getAccessToken(o),c=await t.getIdToken(o),a={access_token:u,token_type:"Bearer",expires_in:900,id_token:c},d=await t.sso.updateRefreshToken(r);return d?{...a,refresh_token:d}:e.code(403).send({error:"This refresh token has been revoked/expired!"})}catch(t){throw t}},ae=async(s,e)=>{try{let t=new y,r=s.token||{sub:null};if(r.sub){let o=s.body.password;return o=B.default.hashSync(o,+($.env.BCRYPT_COST??13)),await t.updatePassword(r.sub,o)}return}catch(t){throw t}};var ue=[{method:"POST",url:"/authorize",handler:re},{method:"GET",url:"/token",handler:se},{method:"POST",url:"/users/signon",handler:ne},{method:"POST",url:"/users/refresh-token",handler:ie},{method:"POST",url:"/users/revoke-token",handler:oe},{method:"POST",url:"/users/update-password",handler:ae}];var Ae=async()=>{let s=new de.default(pe.default.wrapper);s.addAuthPreHandler(le.default,"token"),s.routeMultiple(ue);let e=z.env.APP_VERSION?"/"+z.env.APP_VERSION:"";s.server.register(require("@fastify/static"),{root:ce.default.join(__dirname,".well-known"),prefix:e+"/sso/.well-known/"}),await s.start()};Ae();
