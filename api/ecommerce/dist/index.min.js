var W=Object.create;var q=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var O=(t,o,e,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of J(o))!M.call(t,r)&&r!==e&&q(t,r,{get:()=>o[r],enumerable:!(n=B(o,r))||n.enumerable});return t};var l=(t,o,e)=>(e=t!=null?W(E(t)):{},O(o||!t||!t.__esModule?q(e,"default",{value:t,enumerable:!0}):e,t));var D=l(require("@groupclaes/fastify-elastic")),v=l(require("@groupclaes/fastify-authhandler"));var h=l(require("mssql"));var C=require("mssql"),R=require("./config"),d=new Map,a={get:async t=>{if(!d.has(t)){if(!R.mssql[t])throw new Error(`Configuration for pool '${t}' does not exist!`);let o=new C.ConnectionPool(R.mssql[t]),e=o.close.bind(o);o.close=(...n)=>(d.delete(t),e(...n)),d.set(t,await o.connect())}return d.get(t)},closeAll:()=>Promise.all(Array.from(d.values()).map(t=>t.then(o=>o.close())))};var N="brabopak",m=class{constructor(){this.schema="[ecommerce]."}async getTree(o,e="nl"){try{let n=new h.default.Request(await a.get(N));n.input("user_id",h.default.Int,o),n.input("culture",h.default.VarChar,e);let r=await n.execute(this.schema+"[usp_getCategoriesTree]");return r.recordset.length>0?r.recordset[0]:void 0}catch(n){throw n}}};var I=async(t,o)=>{try{let e=new m,n=t.token||{sub:null},r=t.query.culture??"nl";return await e.getTree(n.sub,r)}catch(e){return o.status(500).send(e)}};var P=l(require("@groupclaes/oe-connector"));var u=l(require("mssql"));var w="brabopak",i=class{constructor(){this.schema="[ecommerce]."}async get(o,e,n="nl"){try{let r=new u.default.Request(await a.get(w));r.input("user_id",u.default.Int,e),r.input("usercode",u.default.Int,o),r.input("culture",u.default.VarChar,n);let s=await r.execute(this.schema+"[usp_getCart]");return s.recordset.length>0?s.recordset[0]:void 0}catch(r){throw r}}async updateProduct(o,e,n,r){try{let s=new u.default.Request(await a.get(w));return s.input("user_id",u.default.Int,e),s.input("usercode",u.default.Int,o),s.input("product_id",u.default.Int,n),s.input("amount",u.default.SmallInt,r),(await s.execute(this.schema+"[usp_updateCartProduct]")).rowsAffected[0]>0}catch(s){throw s}}async getProductInfo(o){try{let e=new u.default.Request(await a.get(w));e.input("product_id",u.default.Int,o);let n=await e.execute(this.schema+"[usp_getCartProductInfo]");return n.recordset.length>0?n.recordset[0]:void 0}catch(e){throw e}}async getUserInfo(o){let e=new u.default.Request(await a.get(w));e.input("user_id",u.default.Int,o);let n=await e.execute("sso.usp_getUserInfo");if(n.recordset.length>0)return n.recordset[0][0]}};var x=async(t,o)=>{try{let e=new i,n=t.token||{sub:null},r=t.query.usercode,s=t.query.culture??"nl";return await e.get(r,n.sub,s)}catch(e){return o.status(500).send(e)}},_=async(t,o)=>{try{let e=new i,n=t.token||{sub:null},r=t.query.usercode,s=t.query.culture??"nl";if(n.sub){let y=await e.updateProduct(r,n.sub,t.body.product_id,t.body.quantity)}return await e.get(r,n.sub,s)}catch(e){return o.status(500).send(e)}},T=async(t,o)=>{try{let e=new i,n=t.token||{sub:null};if(n.sub){let r=t.body,s=await e.getUserInfo(n.sub),y=[];for(let c of r.products){let g=await e.getProductInfo(c.id);y.push({itemnum:g.itemnum,quantity:c.quantity,unit:g.unit})}let A={dsOrders:{ttOrdMst:[{CustNum:r.customer.id,DelvAdr:r.customer.address_id,CustCol:r.deliveryInfo.method!=="transport",ComplDelv:r.deliveryInfo.option!=="parts",CustRef:r.invoiceInfo.reference,DelvDate:void 0,NextDelv:r.invoiceInfo.nextDate,OrdWay:"B2B"}],ttOrdDtl:y.map((c,g)=>({ItemNum:c.itemnum,Qty:c.quantity,SalUnit:c.unit,TmpOrdLine:g})),ttOrdMstText:[{InfoText:r.invoiceInfo.comment}]}};P.default.configure({c:!1});let b=await P.default.run("apslj110b.p",["BRA",A,s.usercode,void 0],{tw:-1,simpleParameters:!0,parameterDefaults:{in:"string",out:"string"}});if(b&&b.status===200&&b.result)return{success:!0}}return o.status(401).send({error:"Unauthorized!"})}catch(e){return t.log.fatal(t.body,"failed to send order!"),o.status(500).send(e)}};var p=l(require("mssql"));var G="brabopak",f=class{constructor(){this.schema="[ecommerce]."}async get(o,e,n="nl"){try{let r=new p.default.Request(await a.get(G));r.input("user_id",p.default.Int,e),r.input("usercode",p.default.Int,o),r.input("culture",p.default.VarChar,n);let s=await r.execute(this.schema+"[usp_getDashboard]");return s.recordset.length>0?s.recordsets:void 0}catch(r){throw r}}};var F=async(t,o)=>{try{let e=new f,n=t.token||{sub:null},r=t.query.culture??"nl";return await e.get(t.query.usercode,n.sub,r)}catch(e){return o.status(500).send(e)}};var k=[{method:"GET",url:"/menu",handler:I},{method:"GET",url:"/carts",handler:x,requiredPermissions:[]},{method:"POST",url:"/carts",handler:T,requiredPermissions:[]},{method:"PUT",url:"/carts/products",handler:_,requiredPermissions:[]},{method:"GET",url:"/dashboard",handler:F,requiredPermissions:[]}];var V=require("./config"),j=async()=>{let t=new D.default(V.wrapper);t.addAuthPreHandler(v.default,"token"),t.routeMultiple(k),await t.start()};j();
