var W=Object.create;var _=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var E=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var M=(t,r,e,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of J(r))!O.call(t,s)&&s!==e&&_(t,s,{get:()=>r[s],enumerable:!(o=B(r,s))||o.enumerable});return t};var l=(t,r,e)=>(e=t!=null?W(E(t)):{},M(r||!t||!t.__esModule?_(e,"default",{value:t,enumerable:!0}):e,t));var v=l(require("@groupclaes/fastify-elastic")),A=l(require("@groupclaes/fastify-authhandler"));var P=l(require("mssql"));var I=require("mssql"),C=require("./config"),f=new Map,i={get:async t=>{if(!f.has(t)){if(!C.mssql[t])throw new Error(`Configuration for pool '${t}' does not exist!`);let r=new I.ConnectionPool(C.mssql[t]),e=r.close.bind(r);r.close=(...o)=>(f.delete(t),e(...o)),f.set(t,await r.connect())}return f.get(t)},closeAll:()=>Promise.all(Array.from(f.values()).map(t=>t.then(r=>r.close())))};var N="brabopak",p=class{constructor(){this.schema="[ecommerce]."}async getTree(r,e="nl"){try{let o=new P.default.Request(await i.get(N));o.input("user_id",P.default.Int,r),o.input("culture",P.default.VarChar,e);let s=await o.execute(this.schema+"[usp_getCategoriesTree]");return s.recordset.length>0?s.recordset[0]:void 0}catch(o){throw o}}};var q=async(t,r)=>{try{let e=new p,o=t.token||{sub:null},s=t.query.culture??"nl";return await e.getTree(o.sub,s)}catch(e){return r.status(500).send(e)}};var g=l(require("@groupclaes/oe-connector"));var u=l(require("mssql"));var y="brabopak",c=class{constructor(){this.schema="[ecommerce]."}async get(r,e,o="nl"){try{let s=new u.default.Request(await i.get(y));s.input("user_id",u.default.Int,e),s.input("usercode",u.default.Int,r),s.input("culture",u.default.VarChar,o);let n=await s.execute(this.schema+"[usp_getCart]");return n.recordset.length>0?n.recordset[0]:void 0}catch(s){throw s}}async updateProduct(r,e,o,s){try{let n=new u.default.Request(await i.get(y));return n.input("user_id",u.default.Int,e),n.input("usercode",u.default.Int,r),n.input("product_id",u.default.Int,o),n.input("amount",u.default.SmallInt,s),(await n.execute(this.schema+"[usp_updateCartProduct]")).rowsAffected[0]>0}catch(n){throw n}}async getProductInfo(r){try{let e=new u.default.Request(await i.get(y));e.input("product_id",u.default.Int,r);let o=await e.execute(this.schema+"[usp_getCartProductInfo]");return o.recordset.length>0?o.recordset[0]:void 0}catch(e){throw e}}async getUserInfo(r){let e=new u.default.Request(await i.get(y));e.input("user_id",u.default.Int,r);let o=await e.execute("sso.usp_getUserInfo");if(o.recordset.length>0)return o.recordset[0][0]}async getUserSettings(r){let e=new u.default.Request(await i.get(y));e.input("usercode",u.default.Int,r);let o=await e.execute("sso.usp_getUserSettings");if(o.recordset.length>0)return o.recordset[0][0]}};var x=async(t,r)=>{try{let e=new c,o=t.token||{sub:null},s=t.query.usercode,n=t.query.culture??"nl";return await e.get(s,o.sub,n)}catch(e){return r.status(500).send(e)}},T=async(t,r)=>{try{let e=new c,o=t.token||{sub:null},s=t.query.usercode,n=t.query.culture??"nl";if(o.sub){let a=await e.updateProduct(s,o.sub,t.body.product_id,t.body.quantity)}return await e.get(s,o.sub,n)}catch(e){return r.status(500).send(e)}},F=async(t,r)=>{try{let e=new c,o=t.token||{sub:null};if(o.sub){let s=t.body,n=await e.getUserInfo(o.sub),a=[];for(let d of s.products){let b=await e.getProductInfo(d.id);a.push({itemnum:b.itemnum,quantity:d.quantity,unit:b.unit})}let m={dsOrders:{ttOrdMst:[{CustNum:s.customer.id,DelvAdr:s.customer.address_id,CustCol:s.deliveryInfo.method!=="transport",ComplDelv:s.deliveryInfo.option!=="parts",CustRef:s.invoiceInfo.reference,DelvDate:void 0,NextDelv:s.invoiceInfo.nextDate,OrdWay:"B2B"}],ttOrdDtl:a.map((d,b)=>({ItemNum:d.itemnum,Qty:d.quantity,SalUnit:d.unit,TmpOrdLine:b})),ttOrdMstText:[{InfoText:s.invoiceInfo.comment}]}};g.default.configure({c:!1});let R=await g.default.run("apslj110b.p",["BRA",m,n.usercode,void 0],{tw:-1,simpleParameters:!0,parameterDefaults:{in:"string",out:"string"}});if(R&&R.status===200&&R.result)return{success:!0}}return r.status(401).send({error:"Unauthorized!"})}catch(e){return t.log.fatal(t.body,"failed to send order!"),r.status(500).send(e)}},k=async(t,r)=>{try{let e=new c,o=t.token||{sub:null};if(o.sub){let s=await e.getUserInfo(o.sub),n=await e.getUserSettings(t.query.usercode);g.default.configure({c:!1,tw:-1,simpleParameters:!0});let a=await g.default.run("getOrderHis",["BRA","user",n.customer_id,n.address_id,25,void 0]);if(t.log.info({token:o,customer_id:n.customer_id,address_id:n.address_id,user:s,customer:n},"Get orders history"),a&&a.status===200){let m=a.result.orders;return m?{statusCode:200,length:m.length,orders:m}:r.code(204).send()}return r.code(a.status).send(a)}return r.status(401).send({error:"Unauthorized!"})}catch(e){return t.log.fatal(t.body,"failed to send order!"),r.status(500).send(e)}};var h=l(require("mssql"));var G="brabopak",w=class{constructor(){this.schema="[ecommerce]."}async get(r,e,o="nl"){try{let s=new h.default.Request(await i.get(G));s.input("user_id",h.default.Int,e),s.input("usercode",h.default.Int,r),s.input("culture",h.default.VarChar,o);let n=await s.execute(this.schema+"[usp_getDashboard]");return n.recordset.length>0?n.recordsets:void 0}catch(s){throw s}}};var D=async(t,r)=>{try{let e=new w,o=t.token||{sub:null},s=t.query.culture??"nl";return await e.get(t.query.usercode,o.sub,s)}catch(e){return r.status(500).send(e)}};var U=[{method:"GET",url:"/menu",handler:q},{method:"GET",url:"/carts",handler:x,requiredPermissions:[]},{method:"POST",url:"/carts",handler:F,requiredPermissions:[]},{method:"PUT",url:"/carts/products",handler:T,requiredPermissions:[]},{method:"GET",url:"/carts/history",handler:k,requiredPermissions:[]},{method:"GET",url:"/dashboard",handler:D,requiredPermissions:[]}];var V=require("./config"),z=async()=>{let t=new v.default(V.wrapper);t.addAuthPreHandler(A.default,"token"),t.routeMultiple(U),await t.start()};z();
