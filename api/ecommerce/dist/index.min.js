var O=Object.create;var C=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,S=Object.prototype.hasOwnProperty;var N=(t,r,e,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of M(r))!S.call(t,o)&&o!==e&&C(t,o,{get:()=>r[o],enumerable:!(s=G(r,o))||s.enumerable});return t};var l=(t,r,e)=>(e=t!=null?O(Q(t)):{},N(r||!t||!t.__esModule?C(e,"default",{value:t,enumerable:!0}):e,t));var B=l(require("@groupclaes/fastify-elastic")),E=l(require("@groupclaes/fastify-authhandler"));var _=l(require("mssql"));var x=require("mssql"),q=require("./config"),y=new Map,c={get:async t=>{if(!y.has(t)){if(!q.mssql[t])throw new Error(`Configuration for pool '${t}' does not exist!`);let r=new x.ConnectionPool(q.mssql[t]),e=r.close.bind(r);r.close=(...s)=>(y.delete(t),e(...s)),y.set(t,await r.connect())}return y.get(t)},closeAll:()=>Promise.all(Array.from(y.values()).map(t=>t.then(r=>r.close())))};var H="brabopak",g=class{constructor(){this.schema="[ecommerce]."}async getTree(r,e="nl"){try{let s=new _.default.Request(await c.get(H));s.input("user_id",_.default.Int,r),s.input("culture",_.default.VarChar,e);let o=await s.execute(this.schema+"[usp_getCategoriesTree]");return o.recordset.length>0?o.recordset[0]:void 0}catch(s){throw s}}};var T=async(t,r)=>{try{let e=new g,s=t.token||{sub:null},o=t.query.culture??"nl";return{status:"success",code:200,data:await e.getTree(s.sub,o)}}catch{return r.status(500).send({status:"error",code:500,message:"failed to get categories tree from database"})}};var I=l(require("@groupclaes/oe-connector"));var u=l(require("mssql"));var h="brabopak",d=class{constructor(){this.schema="[ecommerce]."}async get(r,e,s="nl"){try{let o=new u.default.Request(await c.get(h));o.input("user_id",u.default.Int,e),o.input("usercode",u.default.Int,r),o.input("culture",u.default.VarChar,s);let n=await o.execute(this.schema+"[usp_getCart]");return n.recordset.length>0?n.recordset[0]:void 0}catch(o){throw o}}async updateProduct(r,e,s,o){try{let n=new u.default.Request(await c.get(h));return n.input("user_id",u.default.Int,e),n.input("usercode",u.default.Int,r),n.input("product_id",u.default.Int,s),n.input("amount",u.default.SmallInt,o),(await n.execute(this.schema+"[usp_updateCartProduct]")).rowsAffected[0]>0}catch(n){throw n}}async getProductInfo(r){try{let e=new u.default.Request(await c.get(h));e.input("product_id",u.default.Int,r);let s=await e.execute(this.schema+"[usp_getCartProductInfo]");return s.recordset.length>0?s.recordset[0]:void 0}catch(e){throw e}}async getUserInfo(r){if(!r)return;let e=new u.default.Request(await c.get(h));e.input("user_id",u.default.Int,r);let s=await e.execute("sso.usp_getUserInfo");if(s.recordset.length>0)return s.recordset[0][0]}async getUserSettings(r){let e=new u.default.Request(await c.get(h));e.input("usercode",u.default.Int,r);let s=await e.execute("sso.usp_getUserSettings");if(s.recordset.length>0)return s.recordset[0]}};var F=async(t,r)=>{try{let e=new d,s=t.token||{sub:null},o=t.query.usercode,n=t.query.culture??"nl";return{status:"success",code:200,data:await e.get(o,s.sub,n)}}catch{return r.status(500).send({status:"error",code:500,message:"failed to fetch carts from database"})}},k=async(t,r)=>{try{let e=new d,s=t.token||{sub:null},o=t.query.usercode,n=t.query.culture??"nl";return s.sub&&await e.updateProduct(o,s.sub,t.body.product_id,t.body.quantity),{status:"success",code:200,data:await e.get(o,s.sub,n)}}catch{return r.status(500).send({status:"error",code:500,message:"failed to update cart"})}},U=async(t,r)=>{try{let e=new d,s=t.token||{sub:null};if(s.sub){let o=t.body,n=await e.getUserInfo(s.sub),a=[];for(let i of o.products){let p=await e.getProductInfo(i.id);a.push({itemnum:p.itemnum,quantity:i.quantity,unit:p.unit})}let P={dsOrders:{ttOrdMst:[{CustNum:o.customer.id,DelvAdr:o.customer.address_id,CustCol:o.deliveryInfo.method!=="transport",ComplDelv:o.deliveryInfo.option!=="parts",CustRef:o.invoiceInfo.reference,DelvDate:void 0,NextDelv:o.invoiceInfo.nextDate,OrdWay:"B2B"}],ttOrdDtl:a.map((i,p)=>({ItemNum:i.itemnum,Qty:i.quantity,SalUnit:i.unit,TmpOrdLine:p})),ttOrdMstText:[{InfoText:o.invoiceInfo.comment}]}};I.default.configure({c:!1});let m=await I.default.run("apslj110b.p",["BRA",P,n.usercode,void 0],{tw:-1,simpleParameters:!0,parameterDefaults:{in:"string",out:"string"}});if(m&&m.status===200&&m.result)return{status:"success",data:{success:!0}}}return r.status(401).send({status:"fail",code:401,message:"Unauthorized"})}catch{return t.log.fatal(t.body,"failed to send order!"),r.status(500).send({status:"error",code:500,message:"failed to update cart"})}};var f=l(require("mssql"));var D="brabopak",b=class{constructor(){this.schema="[ecommerce]."}async get(r,e,s="nl"){try{let o=new f.default.Request(await c.get(D));o.input("user_id",f.default.Int,e),o.input("usercode",f.default.Int,r),o.input("culture",f.default.VarChar,s);let n=await o.execute(this.schema+"[usp_getDashboard]");return n.recordset.length>0?n.recordsets:void 0}catch(o){throw o}}async getUserInfo(r){if(!r)return;let e=new f.default.Request(await c.get(D));e.input("user_id",f.default.Int,r);let s=await e.execute("sso.usp_getUserInfo");if(s.recordset.length>0)return s.recordset[0][0]}};var W=async(t,r)=>{try{let e=new b,s=t.token||{sub:null},o=t.query.culture??"nl";if(!s.sub)return r.status(401).send({status:"fail",code:401,message:"Unauthorized"});let n=await e.getUserInfo(s.sub),a=!1;n&&(a=n.user_type===2||n.user_type===3);let P=await e.get(t.query.usercode,s.sub,o);if(!P)return r.status(204).send();let m=P.map(i=>i[0]);if(!a){for(let i of m)if(i.products)for(let p of i.products)p.prices?.forEach(R=>{R.base=0,delete R.amount,delete R.discount,delete R.quantity})}return{status:"success",code:200,data:{blocks:m}}}catch(e){return r.status(500).send({status:"error",code:500,message:"failed to get dashboard",data:{error:e}})}};var w=l(require("@groupclaes/oe-connector"));var A=async(t,r)=>{try{let e=new d,s=t.token||{sub:null};if(s.sub){let o=await e.getUserInfo(s.sub),n=await e.getUserSettings(t.query.usercode);w.default.configure({c:!1,tw:-1,simpleParameters:!0});let a=await w.default.run("getOrder",["BRA","user",n.customer_id,n.address_id,+t.params.id,void 0]);return t.log.info({order_id:t.params.id,customer_id:n.customer_id,address_id:n.address_id,user:o,customer:n},"Get order"),a&&a.status===200?{status:"success",code:a.status,data:a.result}:{status:"fail",code:a.status,data:a.result}}}catch{return t.log.fatal(t.body,"failed to get order!"),r.status(500).send({status:"error",code:500,message:"failed to get order"})}},J=async(t,r)=>{try{let e=new d,s=t.token||{sub:null};if(s.sub){let o=await e.getUserInfo(s.sub),n=await e.getUserSettings(t.query.usercode);w.default.configure({c:!1,tw:-1,simpleParameters:!0});let a=await w.default.run("getOrderHis",["BRA","user",n.customer_id,n.address_id,25,void 0]);return t.log.info({customer_id:n.customer_id,address_id:n.address_id,user:o,customer:n},"Get orders history"),a&&a.status===200?{status:"success",code:a.status,data:a.result}:{status:"fail",code:a.status,data:a.result}}return r.status(401).send({status:"fail",code:401,message:"Unauthorized"})}catch{return t.log.fatal(t.body,"failed to get history!"),r.status(500).send({status:"error",code:500,message:"failed to get order history"})}};var v=[{method:"GET",url:"/menu",handler:T},{method:"GET",url:"/carts",handler:F,requiredPermissions:[]},{method:"POST",url:"/carts",handler:U,requiredPermissions:[]},{method:"PUT",url:"/carts/products",handler:k,requiredPermissions:[]},{method:"GET",url:"/orders/:id",handler:A,requiredPermissions:[]},{method:"GET",url:"/orders",handler:J,requiredPermissions:[]},{method:"GET",url:"/dashboard",handler:W,requiredPermissions:[]}];var $=require("./config"),K=async()=>{let t=new B.default($.wrapper);t.addAuthPreHandler(E.default,"token"),t.routeMultiple(v),await t.start()};K();
