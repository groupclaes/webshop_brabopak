var E=Object.create;var R=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,O=Object.prototype.hasOwnProperty;var U=(e,o,t,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let r of Q(o))!O.call(e,r)&&r!==t&&R(e,r,{get:()=>o[r],enumerable:!(s=M(o,r))||s.enumerable});return e};var c=(e,o,t)=>(t=e!=null?E(N(e)):{},U(o||!e||!e.__esModule?R(t,"default",{value:e,enumerable:!0}):t,e));var A=c(require("@groupclaes/fastify-elastic")),J=c(require("@groupclaes/fastify-authhandler"));var b=c(require("mssql"));var I=require("mssql"),C=require("./config"),p=new Map,a={get:async e=>{if(!p.has(e)){if(!C.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let o=new I.ConnectionPool(C.mssql[e]),t=o.close.bind(o);o.close=(...s)=>(p.delete(e),t(...s)),p.set(e,await o.connect())}return p.get(e)},closeAll:()=>Promise.all(Array.from(p.values()).map(e=>e.then(o=>o.close())))};var G="brabopak",y=class{constructor(){this.schema="[ecommerce]."}async getTree(o,t="nl"){try{let s=new b.default.Request(await a.get(G));s.input("user_id",b.default.Int,o),s.input("culture",b.default.VarChar,t);let r=await s.execute(this.schema+"[usp_getCategoriesTree]");return r.recordset.length>0?r.recordset[0]:void 0}catch(s){throw s}}};var x=async(e,o)=>{try{let t=new y,s=e.token||{sub:null},r=e.query.culture??"nl";return await t.getTree(s.sub,r)}catch(t){return o.status(500).send(t)}};var _=c(require("@groupclaes/oe-connector"));var u=c(require("mssql"));var q="brabopak",l=class{constructor(){this.schema="[ecommerce]."}async get(o,t,s="nl"){try{let r=new u.default.Request(await a.get(q));r.input("user_id",u.default.Int,t),r.input("usercode",u.default.Int,o),r.input("culture",u.default.VarChar,s);let n=await r.execute(this.schema+"[usp_getCart]");return n.recordset.length>0?n.recordset[0]:void 0}catch(r){throw r}}async updateProduct(o,t,s,r){try{let n=new u.default.Request(await a.get(q));return n.input("user_id",u.default.Int,t),n.input("usercode",u.default.Int,o),n.input("product_id",u.default.Int,s),n.input("amount",u.default.SmallInt,r),(await n.execute(this.schema+"[usp_updateCartProduct]")).rowsAffected[0]>0}catch(n){throw n}}async getProductInfo(o){try{let t=new u.default.Request(await a.get(q));t.input("product_id",u.default.Int,o);let s=await t.execute(this.schema+"[usp_getCartProductInfo]");return s.recordset.length>0?s.recordset[0]:void 0}catch(t){throw t}}async getUserInfo(o){let t=new u.default.Request(await a.get(q));t.input("user_id",u.default.Int,o);let s=await t.execute("sso.usp_getUserInfo");if(s.recordset.length>0)return s.recordset[0][0]}};var T=async(e,o)=>{try{let t=new l,s=e.token||{sub:null},r=e.query.usercode,n=e.query.culture??"nl";return await t.get(r,s.sub,n)}catch(t){return o.status(500).send(t)}},F=async(e,o)=>{try{let t=new l,s=e.token||{sub:null},r=e.query.usercode,n=e.query.culture??"nl";if(s.sub){let i=await t.updateProduct(r,s.sub,e.body.product_id,e.body.quantity)}return await t.get(r,s.sub,n)}catch(t){return o.status(500).send(t)}},k=async(e,o)=>{try{let t=new l,s=e.token||{sub:null};if(s.sub){let r=e.body,n=await t.getUserInfo(s.sub),i=[];for(let d of r.products){let w=await t.getProductInfo(d.id);i.push({itemnum:w.itemnum,quantity:d.quantity,unit:w.unit})}let B={dsOrders:{ttOrdMst:[{CustNum:r.customer.id,DelvAdr:r.customer.address_id,CustCol:r.deliveryInfo.method!=="transport",ComplDelv:r.deliveryInfo.option!=="parts",CustRef:r.invoiceInfo.reference,DelvDate:void 0,NextDelv:r.invoiceInfo.nextDate,OrdWay:"B2B"}],ttOrdDtl:i.map((d,w)=>({ItemNum:d.itemnum,Qty:d.quantity,SalUnit:d.unit,TmpOrdLine:w})),ttOrdMstText:[{InfoText:r.invoiceInfo.comment}]}};_.default.configure({c:!1});let P=await _.default.run("apslj110b.p",["BRA",B,n.usercode,void 0],{tw:-1,simpleParameters:!0,parameterDefaults:{in:"string",out:"string"}});if(P&&P.status===200&&P.result)return{success:!0}}return o.status(401).send({error:"Unauthorized!"})}catch(t){return e.log.fatal(e.body,"failed to send order!"),o.status(500).send(t)}};var f=c(require("mssql"));var j="brabopak",g=class{constructor(){this.schema="[ecommerce]."}async get(o,t,s="nl"){try{let r=new f.default.Request(await a.get(j));r.input("user_id",f.default.Int,t),r.input("usercode",f.default.Int,o),r.input("culture",f.default.VarChar,s);let n=await r.execute(this.schema+"[usp_getDashboard]");return n.recordset.length>0?n.recordsets:void 0}catch(r){throw r}}};var D=async(e,o)=>{try{let t=new g,s=e.token||{sub:null},r=e.query.culture??"nl";return await t.get(e.query.usercode,s.sub,r)}catch(t){return o.status(500).send(t)}};var m=c(require("mssql"));var H="brabopak",h=class{constructor(){this.schema="[search]."}async getQueries(o){try{let t=new m.default.Request(await a.get(H));t.input("user_id",m.default.Int,o.user_id),t.input("query",m.default.VarChar,o.query),t.input("culture",m.default.Char,o.culture),t.input("category_id",m.default.Int,o.category_id);let s=await t.execute(this.schema+"[usp_get]"),r=s.recordsets[0].map(i=>i.query),n=s.recordsets[1].map(i=>i.query);return{results:r,popular:n}}catch(t){throw t}}};var W=async(e,o)=>{try{let t=new h,s=e.token||{sub:null},r=e.query.query,n=e.query.culture??"nl",i=e.query.category_id;return await t.getQueries({user_id:s.sub,query:r,culture:n,category_id:i})}catch(t){return o.status(500).send(t)}};var v=[{method:"GET",url:"/menu",handler:x},{method:"GET",url:"/search",handler:W,requiredPermissions:[void 0]},{method:"GET",url:"/carts",handler:T,requiredPermissions:[]},{method:"POST",url:"/carts",handler:k,requiredPermissions:[]},{method:"PUT",url:"/carts/products",handler:F,requiredPermissions:[]},{method:"GET",url:"/dashboard",handler:D,requiredPermissions:[]}];var $=require("./config"),K=async()=>{let e=new A.default($.wrapper);e.addAuthPreHandler(J.default,"token"),e.routeMultiple(v),await e.start()};K();
