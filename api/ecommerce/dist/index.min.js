var A=Object.create;var q=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var M=(t,o,r,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let e of B(o))!E.call(t,e)&&e!==r&&q(t,e,{get:()=>o[e],enumerable:!(n=W(o,e))||n.enumerable});return t};var l=(t,o,r)=>(r=t!=null?A(J(t)):{},M(o||!t||!t.__esModule?q(r,"default",{value:t,enumerable:!0}):r,t));var D=l(require("@groupclaes/fastify-elastic")),v=l(require("@groupclaes/fastify-authhandler"));var h=l(require("mssql"));var R=require("mssql"),C=require("./config"),d=new Map,a={get:async t=>{if(!d.has(t)){if(!C.mssql[t])throw new Error(`Configuration for pool '${t}' does not exist!`);let o=new R.ConnectionPool(C.mssql[t]),r=o.close.bind(o);o.close=(...n)=>(d.delete(t),r(...n)),d.set(t,await o.connect())}return d.get(t)},closeAll:()=>Promise.all(Array.from(d.values()).map(t=>t.then(o=>o.close())))};var O="brabopak",m=class{constructor(){this.schema="[ecommerce]."}async getTree(o,r="nl"){try{let n=new h.default.Request(await a.get(O));n.input("user_id",h.default.Int,o),n.input("culture",h.default.VarChar,r);let e=await n.execute(this.schema+"[usp_getCategoriesTree]");return e.recordset.length>0?e.recordset[0]:void 0}catch(n){throw n}}};var x=async(t,o)=>{try{let r=new m,n=t.token||{sub:null},e=t.query.culture??"nl";return await r.getTree(n.sub,e)}catch(r){return o.status(500).send(r)}};var P=l(require("@groupclaes/oe-connector"));var u=l(require("mssql"));var w="brabopak",c=class{constructor(){this.schema="[ecommerce]."}async get(o,r,n="nl"){try{let e=new u.default.Request(await a.get(w));e.input("user_id",u.default.Int,r),e.input("usercode",u.default.Int,o),e.input("culture",u.default.VarChar,n);let s=await e.execute(this.schema+"[usp_getCart]");return s.recordset.length>0?s.recordset[0]:void 0}catch(e){throw e}}async updateProduct(o,r,n,e){try{let s=new u.default.Request(await a.get(w));return s.input("user_id",u.default.Int,r),s.input("usercode",u.default.Int,o),s.input("product_id",u.default.Int,n),s.input("amount",u.default.SmallInt,e),(await s.execute(this.schema+"[usp_updateCartProduct]")).rowsAffected[0]>0}catch(s){throw s}}async getProductInfo(o){try{let r=new u.default.Request(await a.get(w));r.input("product_id",u.default.Int,o);let n=await r.execute(this.schema+"[usp_getCartProductInfo]");return n.recordset.length>0?n.recordset[0]:void 0}catch(r){throw r}}};var I=async(t,o)=>{try{let r=new c,n=t.token||{sub:null},e=t.query.usercode,s=t.query.culture??"nl";return await r.get(e,n.sub,s)}catch(r){return o.status(500).send(r)}},T=async(t,o)=>{try{let r=new c,n=t.token||{sub:null},e=t.query.usercode,s=t.query.culture??"nl";if(n.sub){let g=await r.updateProduct(e,n.sub,t.body.product_id,t.body.quantity)}return await r.get(e,n.sub,s)}catch(r){return o.status(500).send(r)}},_=async(t,o)=>{try{let r=new c;if((t.token||{sub:null}).sub){let e=t.body;console.debug(e);let s=[];for(let i of e.products){let y=await r.getProductInfo(i.id);s.push({itemnum:y.itemnum,quantity:i.quantity,unit:y.unit})}let g={dsOrders:{ttOrdMst:[{CustNum:e.customer.id,DelvAdr:e.customer.address_id,CustCol:e.deliveryInfo.method!=="transport",ComplDelv:e.deliveryInfo.option!=="parts",CustRef:e.invoiceInfo.reference,DelvDate:void 0,NextDelv:e.invoiceInfo.nextDate,OrdWay:"B2B"}],ttOrdDtl:s.map((i,y)=>({ItemNum:i.itemnum,Qty:i.quantity,SalUnit:i.unit,TmpOrdLine:y})),ttOrdMstText:[{InfoText:e.invoiceInfo.comment}]}};P.default.configure({c:!1});let b=await P.default.run("apslj110b.p",["BRA",g,void 0],{tw:-1,simpleParameters:!0});if(b&&b.status===200&&b.result)return{success:!0}}return o.status(401).send({error:"Unauthorized!"})}catch(r){return t.log.fatal(t.body,"failed to send order!"),o.status(500).send(r)}};var p=l(require("mssql"));var G="brabopak",f=class{constructor(){this.schema="[ecommerce]."}async get(o,r,n="nl"){try{let e=new p.default.Request(await a.get(G));e.input("user_id",p.default.Int,r),e.input("usercode",p.default.Int,o),e.input("culture",p.default.VarChar,n);let s=await e.execute(this.schema+"[usp_getDashboard]");return s.recordset.length>0?s.recordsets:void 0}catch(e){throw e}}};var F=async(t,o)=>{try{let r=new f,n=t.token||{sub:null},e=t.query.culture??"nl";return await r.get(t.query.usercode,n.sub,e)}catch(r){return o.status(500).send(r)}};var k=[{method:"GET",url:"/menu",handler:x},{method:"GET",url:"/carts",handler:I,requiredPermissions:[]},{method:"POST",url:"/carts",handler:_,requiredPermissions:[]},{method:"PUT",url:"/carts/products",handler:T,requiredPermissions:[]},{method:"GET",url:"/dashboard",handler:F,requiredPermissions:[]}];var U=require("./config"),V=async()=>{let t=new D.default(U.wrapper);t.addAuthPreHandler(v.default,"token"),t.routeMultiple(k),await t.start()};V();
