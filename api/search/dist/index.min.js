var M=Object.create;var k=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var G=(e,r,t,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of V(r))!D.call(e,i)&&i!==t&&k(e,i,{get:()=>r[i],enumerable:!(s=O(r,i))||s.enumerable});return e};var b=(e,r,t)=>(t=e!=null?M(W(e)):{},G(r||!e||!e.__esModule?k(t,"default",{value:e,enumerable:!0}):t,e));var T=b(require("@groupclaes/fastify-elastic")),A=b(require("@groupclaes/fastify-authhandler"));var R=b(require("@groupclaes/oe-connector"));var o=b(require("mssql"));var B=require("mssql"),x=require("./config"),f=new Map,C={get:async e=>{if(!f.has(e)){if(!x.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let r=new B.ConnectionPool(x.mssql[e]),t=r.close.bind(r);r.close=(...s)=>(f.delete(e),t(...s)),f.set(e,await r.connect())}return f.get(e)},closeAll:()=>Promise.all(Array.from(f.values()).map(e=>e.then(r=>r.close())))};var F="brabopak",p=class{constructor(){this.schema="[search]."}async getQueries(r){try{let t=new o.default.Request(await C.get(F));t.input("user_id",o.default.Int,r.user_id),t.input("query",o.default.VarChar,r.query),t.input("culture",o.default.Char,r.culture),t.input("category_id",o.default.Int,r.category_id);let s=await t.execute(this.schema+"[usp_get]"),i=s.recordsets[0].map(n=>n.query),a=s.recordsets[1].map(n=>n.query);return{results:i,popular:a}}catch(t){throw t}}async search(r,t,s,i,a,n,h,w,_,q){try{let u=new o.default.Request(await C.get(F));u.input("user_id",o.default.Int,q),u.input("usercode",o.default.Int,r),u.input("culture",o.default.VarChar,t),u.input("query",o.default.VarChar,s),u.input("only_favorites",o.default.Bit,i),u.input("only_promo",o.default.Bit,a),u.input("only_new",o.default.Bit,n),u.input("page",o.default.Int,h),u.input("per_page",o.default.Int,w),u.input("category",o.default.Int,_);let d=await u.execute(this.schema+"usp_post");return{count:d.recordset[0]?.count,results:d.recordsets[1][0]??[],breadcrumbs:d.recordsets[2]??[]}}catch(u){throw u}}};var I=async(e,r)=>{try{let t=new p,s=e.token||{sub:null},i=e.query.query,a=e.query.culture??"nl",n=e.query.category_id;return await t.getQueries({user_id:s.sub,query:i,culture:a,category_id:n})}catch(t){return r.status(500).send(t)}},v=async(e,r)=>{let t=performance.now();try{let s=new p,i=e.token||{sub:null},a=e.query.usercode,n=e.body??{},h=e.query.culture??n.culture??"nl",w=n.query??"",_=n.only_favorites??!1,q=n.only_promo??!1,u=n.only_new??!1,d=n.page??0,E=n.per_page??48,Q=n.category_id??null,y=await s.search(a,h,w,_,q,u,d,E,Q,i.sub),P=y.results;if(console.log(y),a!==0){let g;R.default.configure({c:!1,tw:1e3,simpleParameters:!0});let m=await R.default.run("getProdInfo",["BRA",0,0,y.results.map(c=>({id:c.id,itemNum:c.itemNum})),void 0]);m&&m.status===200&&(g=m.result.id!==void 0?[m.result]:m.result,P.forEach(c=>{let l=g.find(J=>J.itemNum===c.itemNum);c.stock=l!==void 0?l.stock:-1,c.availableOn=l!==void 0?l.availableOn:null,c.inBackorder=l!==void 0?l.inBackorder:!1}))}else P.forEach(g=>{g.prices=null});return{productCount:y.count,products:P,breadcrumbs:y.breadcrumbs,executionTime:performance.now()-t}}catch(s){return r.status(500).send(s)}};var N=[{method:"GET",url:"",handler:I,requiredPermissions:[]},{method:"POST",url:"",handler:v,requiredPermissions:[]}];var S=require("./config"),$=async()=>{let e=new T.default(S.wrapper);e.addAuthPreHandler(A.default,"token"),e.routeMultiple(N),await e.start()};$();
