var O=Object.create;var k=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var H=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of W(t))!G.call(e,a)&&a!==r&&k(e,a,{get:()=>t[a],enumerable:!(o=U(t,a))||o.enumerable});return e};var h=(e,t,r)=>(r=e!=null?O(D(e)):{},H(t||!e||!e.__esModule?k(r,"default",{value:e,enumerable:!0}):r,e));var A=h(require("@groupclaes/fastify-elastic")),E=h(require("@groupclaes/fastify-authhandler"));var R=h(require("@groupclaes/oe-connector"));var s=h(require("mssql"));var F=require("mssql"),B=require("./config"),g=new Map,_={get:async e=>{if(!g.has(e)){if(!B.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let t=new F.ConnectionPool(B.mssql[e]),r=t.close.bind(t);t.close=(...o)=>(g.delete(e),r(...o)),g.set(e,await t.connect())}return g.get(e)},closeAll:()=>Promise.all(Array.from(g.values()).map(e=>e.then(t=>t.close())))};var I="brabopak",p=class{constructor(){this.schema="[search]."}async getQueries(t){try{let r=new s.default.Request(await _.get(I));r.input("user_id",s.default.Int,t.user_id),r.input("query",s.default.VarChar,t.query),r.input("culture",s.default.Char,t.culture),r.input("category_id",s.default.Int,t.category_id);let o=await r.execute(this.schema+"[usp_get]"),a=o.recordsets[0].map(n=>n.query),c=o.recordsets[1].map(n=>n.query);return{results:a,popular:c}}catch(r){throw r}}async search(t,r,o,a,c,n,m,b,q,P){try{let u=new s.default.Request(await _.get(I));u.input("user_id",s.default.Int,P),u.input("usercode",s.default.Int,t),u.input("culture",s.default.VarChar,r),u.input("query",s.default.VarChar,o),u.input("only_favorites",s.default.Bit,a),u.input("only_promo",s.default.Bit,c),u.input("only_new",s.default.Bit,n),u.input("page",s.default.Int,m),u.input("per_page",s.default.Int,b),u.input("category",s.default.Int,q);let y=await u.execute(this.schema+"usp_post");return{count:y.recordset[0]?.count,results:y.recordsets[1][0]??[],breadcrumbs:y.recordsets[2]??[]}}catch(u){throw u}}async getUserInfo(t){let r=new s.default.Request(await _.get(I));r.input("user_id",s.default.Int,t);let o=await r.execute("sso.usp_getUserInfo");if(o.recordset.length>0)return o.recordset[0][0]}};var v=async(e,t)=>{let r=performance.now();try{let o=new p,a=e.token||{sub:null},c=e.query.query,n=e.query.culture??"nl",m=e.query.category_id;return{status:"success",code:200,data:await o.getQueries({user_id:a.sub,query:c,culture:n,category_id:m}),executionTime:performance.now()-r}}catch{return t.status(500).send({status:"error",code:500,message:"failed to get search queries"})}},T=async(e,t)=>{let r=performance.now();try{let o=new p,a=e.token||{sub:null},c=e.query.usercode,n=e.body??{},m=e.query.culture??n.culture??"nl",b=n.query??"",q=n.only_favorites??!1,P=n.only_promo??!1,u=n.only_new??!1,y=n.page??0,Q=n.per_page??48,V=n.category_id??null,w=await o.search(c,m,b,q,P,u,y,Q,V,a.sub),C=w.results,x=await o.getUserInfo(a.sub),J=x.uer_type===2||x.uer_type===3;if(c!==0){let f;R.default.configure({c:!1,tw:1e3,simpleParameters:!0});let i=await R.default.run("getProdInfo",["BRA",0,0,w.results.map(l=>({id:l.id,itemNum:l.itemNum})),void 0]);i&&i.status===200&&(f=i.result.id!==void 0?[i.result]:i.result,C.forEach(l=>{let d=f.find(M=>M.itemNum===l.itemNum);l.stock=d!==void 0?d.stock:-1,l.availableOn=d!==void 0?d.availableOn:null,l.inBackorder=d!==void 0?d.inBackorder:!1}))}if(!J){for(let f of C)if(f.prices)for(let i of f.prices)i.base=0,delete i.amount,delete i.discount,delete i.quantity}return{status:"success",code:200,data:{productCount:w.count,products:C,breadcrumbs:w.breadcrumbs},executionTime:performance.now()-r}}catch(o){return t.status(500).send({status:"error",code:500,message:"failed to search in products",data:{err:o}})}};var N=[{method:"GET",url:"",handler:v,requiredPermissions:[]},{method:"POST",url:"",handler:T,requiredPermissions:[]}];var $=require("./config"),j=async()=>{let e=new A.default($.wrapper);e.addAuthPreHandler(E.default,"token"),e.routeMultiple(N),await e.start()};j();
