var M=Object.create;var k=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var W=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var G=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of V(t))!D.call(e,a)&&a!==r&&k(e,a,{get:()=>t[a],enumerable:!(n=O(t,a))||n.enumerable});return e};var w=(e,t,r)=>(r=e!=null?M(W(e)):{},G(t||!e||!e.__esModule?k(r,"default",{value:e,enumerable:!0}):r,e));var N=w(require("@groupclaes/fastify-elastic")),A=w(require("@groupclaes/fastify-authhandler"));var R=w(require("@groupclaes/oe-connector"));var o=w(require("mssql"));var B=require("mssql"),x=require("./config"),g=new Map,C={get:async e=>{if(!g.has(e)){if(!x.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let t=new B.ConnectionPool(x.mssql[e]),r=t.close.bind(t);t.close=(...n)=>(g.delete(e),r(...n)),g.set(e,await t.connect())}return g.get(e)},closeAll:()=>Promise.all(Array.from(g.values()).map(e=>e.then(t=>t.close())))};var F="brabopak",p=class{constructor(){this.schema="[search]."}async getQueries(t){try{let r=new o.default.Request(await C.get(F));r.input("user_id",o.default.Int,t.user_id),r.input("query",o.default.VarChar,t.query),r.input("culture",o.default.Char,t.culture),r.input("category_id",o.default.Int,t.category_id);let n=await r.execute(this.schema+"[usp_get]"),a=n.recordsets[0].map(s=>s.query),c=n.recordsets[1].map(s=>s.query);return{results:a,popular:c}}catch(r){throw r}}async search(t,r,n,a,c,s,d,h,_,q){try{let u=new o.default.Request(await C.get(F));u.input("user_id",o.default.Int,q),u.input("usercode",o.default.Int,t),u.input("culture",o.default.VarChar,r),u.input("query",o.default.VarChar,n),u.input("only_favorites",o.default.Bit,a),u.input("only_promo",o.default.Bit,c),u.input("only_new",o.default.Bit,s),u.input("page",o.default.Int,d),u.input("per_page",o.default.Int,h),u.input("category",o.default.Int,_);let m=await u.execute(this.schema+"usp_post");return{count:m.recordset[0]?.count,results:m.recordsets[1][0]??[],breadcrumbs:m.recordsets[2]??[]}}catch(u){throw u}}};var I=async(e,t)=>{let r=performance.now();try{let n=new p,a=e.token||{sub:null},c=e.query.query,s=e.query.culture??"nl",d=e.query.category_id;return{status:"success",code:200,data:await n.getQueries({user_id:a.sub,query:c,culture:s,category_id:d}),executionTime:performance.now()-r}}catch{return t.status(500).send({status:"error",code:500,message:"failed to get search queries"})}},v=async(e,t)=>{let r=performance.now();try{let n=new p,a=e.token||{sub:null},c=e.query.usercode,s=e.body??{},d=e.query.culture??s.culture??"nl",h=s.query??"",_=s.only_favorites??!1,q=s.only_promo??!1,u=s.only_new??!1,m=s.page??0,E=s.per_page??48,Q=s.category_id??null,y=await n.search(c,d,h,_,q,u,m,E,Q,a.sub),P=y.results;if(console.log(y),c!==0){let b;R.default.configure({c:!1,tw:1e3,simpleParameters:!0});let f=await R.default.run("getProdInfo",["BRA",0,0,y.results.map(i=>({id:i.id,itemNum:i.itemNum})),void 0]);f&&f.status===200&&(b=f.result.id!==void 0?[f.result]:f.result,P.forEach(i=>{let l=b.find(J=>J.itemNum===i.itemNum);i.stock=l!==void 0?l.stock:-1,i.availableOn=l!==void 0?l.availableOn:null,i.inBackorder=l!==void 0?l.inBackorder:!1}))}else P.forEach(b=>{b.prices=null});return{status:"success",code:200,data:{productCount:y.count,products:P,breadcrumbs:y.breadcrumbs},executionTime:performance.now()-r}}catch{return t.status(500).send({status:"error",code:500,message:"failed to search in products"})}};var T=[{method:"GET",url:"",handler:I,requiredPermissions:[]},{method:"POST",url:"",handler:v,requiredPermissions:[]}];var S=require("./config"),$=async()=>{let e=new N.default(S.wrapper);e.addAuthPreHandler(A.default,"token"),e.routeMultiple(T),await e.start()};$();
