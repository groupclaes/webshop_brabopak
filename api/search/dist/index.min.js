var A=Object.create;var w=Object.defineProperty;var E=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var J=Object.getPrototypeOf,M=Object.prototype.hasOwnProperty;var V=(e,r,t,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let c of Q(r))!M.call(e,c)&&c!==t&&w(e,c,{get:()=>r[c],enumerable:!(s=E(r,c))||s.enumerable});return e};var b=(e,r,t)=>(t=e!=null?A(J(e)):{},V(r||!e||!e.__esModule?w(t,"default",{value:e,enumerable:!0}):t,e));var I=b(require("@groupclaes/fastify-elastic")),k=b(require("@groupclaes/fastify-authhandler"));var o=b(require("mssql"));var P=require("mssql"),q=require("./config"),p=new Map,h={get:async e=>{if(!p.has(e)){if(!q.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let r=new P.ConnectionPool(q.mssql[e]),t=r.close.bind(r);r.close=(...s)=>(p.delete(e),t(...s)),p.set(e,await r.connect())}return p.get(e)},closeAll:()=>Promise.all(Array.from(p.values()).map(e=>e.then(r=>r.close())))};var C="brabopak",i=class{constructor(){this.schema="[search]."}async getQueries(r){try{let t=new o.default.Request(await h.get(C));t.input("user_id",o.default.Int,r.user_id),t.input("query",o.default.VarChar,r.query),t.input("culture",o.default.Char,r.culture),t.input("category_id",o.default.Int,r.category_id);let s=await t.execute(this.schema+"[usp_get]"),c=s.recordsets[0].map(n=>n.query),a=s.recordsets[1].map(n=>n.query);return{results:c,popular:a}}catch(t){throw t}}async search(r,t,s,c,a,n,d,m,g,f){try{let u=new o.default.Request(await h.get(C));u.input("user_id",o.default.Int,f),u.input("usercode",o.default.Int,r),u.input("culture",o.default.VarChar,t),u.input("query",o.default.VarChar,s),u.input("only_favorites",o.default.Bit,c),u.input("only_promo",o.default.Bit,a),u.input("only_new",o.default.Bit,n),u.input("page",o.default.Int,d),u.input("per_page",o.default.Int,m),u.input("category",o.default.Int,g);let l=await u.execute(this.schema+"usp_post");return{count:l.recordset[0]?.count,results:l.recordsets[1][0]??[],breadcrumbs:l.recordsets[2]??[]}}catch(u){throw u}}};var x=async(e,r)=>{try{let t=new i,s=e.token||{sub:null},c=e.query.query,a=e.query.culture??"nl",n=e.query.category_id;return await t.getQueries({user_id:s.sub,query:c,culture:a,category_id:n})}catch(t){return r.status(500).send(t)}},F=async(e,r)=>{let t=performance.now();try{let s=new i,c=e.token||{sub:null},a=e.query.usercode,n=e.body??{},d=e.query.culture??n.culture??"nl",m=n.query??"",g=n.only_favorites??!1,f=n.only_promo??!1,u=n.only_new??!1,l=n.page??0,T=n.per_page??48,v=n.category_id??null,y=await s.search(a,d,m,g,f,u,l,T,v,c.sub),_=y.results;return console.log(y),a!==0||_.forEach(B=>{B.prices=null}),{productCount:y.count,products:_,breadcrumbs:y.breadcrumbs,executionTime:performance.now()-t}}catch(s){return r.status(500).send(s)}};var R=[{method:"GET",url:"",handler:x,requiredPermissions:[]},{method:"POST",url:"",handler:F,requiredPermissions:[]}];var N=require("./config"),D=async()=>{let e=new I.default(N.wrapper);e.addAuthPreHandler(k.default,"token"),e.routeMultiple(R),await e.start()};D();
