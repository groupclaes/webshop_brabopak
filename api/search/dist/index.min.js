var U=Object.create;var F=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var D=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var H=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of O(t))!G.call(e,a)&&a!==r&&F(e,a,{get:()=>t[a],enumerable:!(o=W(t,a))||o.enumerable});return e};var h=(e,t,r)=>(r=e!=null?U(D(e)):{},H(t||!e||!e.__esModule?F(r,"default",{value:e,enumerable:!0}):r,e));var E=h(require("@groupclaes/fastify-elastic")),Q=h(require("@groupclaes/fastify-authhandler"));var x=h(require("@groupclaes/oe-connector"));var n=h(require("mssql"));var B=require("mssql"),v=require("./config"),g=new Map,_={get:async e=>{if(!g.has(e)){if(!v.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let t=new B.ConnectionPool(v.mssql[e]),r=t.close.bind(t);t.close=(...o)=>(g.delete(e),r(...o)),g.set(e,await t.connect())}return g.get(e)},closeAll:()=>Promise.all(Array.from(g.values()).map(e=>e.then(t=>t.close())))};var R="brabopak",p=class{constructor(){this.schema="[search]."}async getQueries(t){try{let r=new n.default.Request(await _.get(R));r.input("user_id",n.default.Int,t.user_id),r.input("query",n.default.VarChar,t.query),r.input("culture",n.default.Char,t.culture),r.input("category_id",n.default.Int,t.category_id);let o=await r.execute(this.schema+"[usp_get]"),a=o.recordsets[0].map(s=>s.query),c=o.recordsets[1].map(s=>s.query);return{results:a,popular:c}}catch(r){throw r}}async search(t,r,o,a,c,s,f,b,q,P){try{let u=new n.default.Request(await _.get(R));u.input("user_id",n.default.Int,P),u.input("usercode",n.default.Int,t),u.input("culture",n.default.VarChar,r),u.input("query",n.default.VarChar,o),u.input("only_favorites",n.default.Bit,a),u.input("only_promo",n.default.Bit,c),u.input("only_new",n.default.Bit,s),u.input("page",n.default.Int,f),u.input("per_page",n.default.Int,b),u.input("category",n.default.Int,q);let m=await u.execute(this.schema+"usp_post");return{count:m.recordset[0]?.count,results:m.recordsets[1][0]??[],breadcrumbs:m.recordsets[2]??[]}}catch(u){throw u}}async getUserInfo(t){if(!t)return;let r=new n.default.Request(await _.get(R));r.input("user_id",n.default.Int,t);let o=await r.execute("sso.usp_getUserInfo");if(o.recordset.length>0)return o.recordset[0][0]}};var T=async(e,t)=>{let r=performance.now();try{let o=new p,a=e.token||{sub:null},c=e.query.query,s=e.query.culture??"nl",f=e.query.category_id;return{status:"success",code:200,data:await o.getQueries({user_id:a.sub,query:c,culture:s,category_id:f}),executionTime:performance.now()-r}}catch{return t.status(500).send({status:"error",code:500,message:"failed to get search queries"})}},N=async(e,t)=>{let r=performance.now();try{let o=new p,a=e.token||{sub:null},c=e.query.usercode,s=e.body??{},f=e.query.culture??s.culture??"nl",b=s.query??"",q=s.only_favorites??!1,P=s.only_promo??!1,u=s.only_new??!1,m=s.page??0,V=s.per_page??48,J=s.category_id??null,w=await o.search(c,f,b,q,P,u,m,V,J,a.sub),C=w.results,I=await o.getUserInfo(a.sub),k=!1;if(I&&(k=I.user_type===2||I.user_type===3),c!==0){let y;x.default.configure({c:!1,tw:1e3,simpleParameters:!0});let i=await x.default.run("getProdInfo",["BRA",0,0,w.results.map(l=>({id:l.id,itemNum:l.itemNum})),void 0]);i&&i.status===200&&(y=i.result.id!==void 0?[i.result]:i.result,C.forEach(l=>{let d=y.find(M=>M.itemNum===l.itemNum);l.stock=d!==void 0?d.stock:-1,l.available_on=d!==void 0?d.availableOn:null,l.in_backorder=d!==void 0?d.inBackorder:!1}))}if(!k){for(let y of C)if(y.prices)for(let i of y.prices)i.base=0,delete i.amount,delete i.discount,delete i.quantity}return{status:"success",code:200,data:{productCount:w.count,products:C,breadcrumbs:w.breadcrumbs},executionTime:performance.now()-r}}catch(o){return t.status(500).send({status:"error",code:500,message:"failed to search in products",data:{err:o}})}};var A=[{method:"GET",url:"",handler:T,requiredPermissions:[]},{method:"POST",url:"",handler:N,requiredPermissions:[]}];var $=require("./config"),j=async()=>{let e=new E.default($.wrapper);e.addAuthPreHandler(Q.default,"token"),e.routeMultiple(A),await e.start()};j();
