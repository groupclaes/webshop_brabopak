var N=Object.create;var _=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,G=Object.prototype.hasOwnProperty;var J=(e,r,t,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of W(r))!G.call(e,n)&&n!==t&&_(e,n,{get:()=>r[n],enumerable:!(s=V(r,n))||s.enumerable});return e};var w=(e,r,t)=>(t=e!=null?N(A(e)):{},J(r||!e||!e.__esModule?_(t,"default",{value:e,enumerable:!0}):t,e));var R=w(require("@groupclaes/fastify-elastic")),F=w(require("@groupclaes/fastify-authhandler"));var o=w(require("mssql"));var C=require("mssql"),q=require("./config"),m=new Map,f={get:async e=>{if(!m.has(e)){if(!q.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let r=new C.ConnectionPool(q.mssql[e]),t=r.close.bind(r);r.close=(...s)=>(m.delete(e),t(...s)),m.set(e,await r.connect())}return m.get(e)},closeAll:()=>Promise.all(Array.from(m.values()).map(e=>e.then(r=>r.close())))};var g="brabopak",d=class{constructor(){this.schema="[product]."}async get(r,t,s,n){try{let u=new o.default.Request(await f.get(g));u.input("id",o.default.Int,r),u.input("user_id",o.default.VarChar,n),u.input("usercode",o.default.Int,t),u.input("culture",o.default.VarChar,s);let c=await u.execute(this.schema+"[usp_get]");return c.recordset.length>0?c.recordset[0]:void 0}catch(u){throw u}}async getBase(r,t,s){try{let n=new o.default.Request(await f.get(g));n.input("id",o.default.Int,r),n.input("usercode",o.default.Int,t),n.input("culture",o.default.VarChar,s);let u=await n.execute(this.schema+"[usp_getBase]");return u.recordset.length>0?u.recordset[0]:void 0}catch(n){throw n}}async findItemNumById(r){try{let t=new o.default.Request(await f.get(g));t.input("id",o.default.Int,r);let s=await t.execute("findItemNumById");return s.recordset.length>0?s.recordset[0].itemNum:void 0}catch(t){throw t}}async search(r,t,s,n,u,c,i,l,p,h){try{let a=new o.default.Request(await f.get(g));a.input("user_id",o.default.Int,h),a.input("usercode",o.default.Int,r),a.input("culture",o.default.VarChar,t),a.input("query",o.default.VarChar,s),a.input("only_favorites",o.default.Bit,n),a.input("only_promo",o.default.Bit,u),a.input("only_new",o.default.Bit,c),a.input("page",o.default.Int,i),a.input("per_page",o.default.Int,l),a.input("category",o.default.Int,p);let y=await a.execute(this.schema+"usp_search");return{count:y.recordset[0]?.count,results:y.recordsets[1][0]??[]}}catch(a){throw a}}};var I=async(e,r)=>{try{let t=new d,s=e.token||{sub:null},{id:n}=e.params,u=e.query.usercode,c=e.query.culture??"nl",i,l={product:await t.get(n,u,c,s.sub)};if(l.product===null){r.status(401).send({verified:!1,error:"Wrong credentials"});return}if(l.product.error){r.status(404).send({error:l.product.error});return}i&&l.product&&(l.product.stock=i!==void 0?i.stock:-1,l.product.availableOn=i!==void 0?i.availableOn:null,l.product.inBackorder=i!==void 0?i.inBackorder:!1);let p=i!==void 0?i.stock:-1;return e.log.info({productId:n,usercode:u,stock:p,culture:c},"Get product details"),l}catch(t){return r.status(500).send(t)}},B=async(e,r)=>{try{let t=new d,s=e.params.id,n=e.query.usercode,u=e.query.culture??"nl",c={product:await t.getBase(s,n,u)};if(c.product===null){r.status(401).send({verified:!1,error:"Wrong credentials"});return}return c}catch(t){return r.status(500).send(t)}},k=async(e,r)=>{let t=performance.now();try{let s=new d,n=e.token||{sub:null},u=e.query.usercode,c=e.body??{},i=e.query.culture??c.culture??"nl",l=c.query??"",p=c.only_favorites??!1,h=c.only_promo??!1,a=c.only_new??!1,y=c.page??0,v=c.per_page??48,T=c.category_id??null,b=await s.search(u,i,l,p,h,a,y,v,T,n.sub),P=b.results;return u!==0||P.forEach(E=>{E.prices=null}),{productCount:b.count,products:P,executionTime:performance.now()-t}}catch(s){return r.status(500).send(s)}};var x=[{method:"GET",url:"/:id",handler:I,requiredPermissions:[]},{method:"GET",url:"/:id/base",handler:B,requiredPermissions:[]},{method:"POST",url:"/search",handler:k,requiredPermissions:[]}];var O=require("./config"),Q=async()=>{let e=new R.default(O.wrapper);e.addAuthPreHandler(F.default,"token"),e.routeMultiple(x),await e.start()};Q();
