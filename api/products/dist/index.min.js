var C=Object.create;var h=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var T=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of k(r))!N.call(e,n)&&n!==t&&h(e,n,{get:()=>r[n],enumerable:!(o=x(r,n))||o.enumerable});return e};var y=(e,r,t)=>(t=e!=null?C(A(e)):{},T(r||!e||!e.__esModule?h(t,"default",{value:e,enumerable:!0}):t,e));var F=y(require("@groupclaes/fastify-elastic")),v=y(require("@groupclaes/fastify-authhandler"));var g=y(require("@groupclaes/oe-connector"));var i=y(require("mssql"));var P=require("mssql"),b=require("./config"),p=new Map,m={get:async e=>{if(!p.has(e)){if(!b.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let r=new P.ConnectionPool(b.mssql[e]),t=r.close.bind(r);r.close=(...o)=>(p.delete(e),t(...o)),p.set(e,await r.connect())}return p.get(e)},closeAll:()=>Promise.all(Array.from(p.values()).map(e=>e.then(r=>r.close())))};var f="brabopak",l=class{constructor(){this.schema="[product]."}async get(r,t,o,n){try{let s=new i.default.Request(await m.get(f));s.input("id",i.default.Int,r),s.input("user_id",i.default.VarChar,n),s.input("usercode",i.default.Int,t),s.input("culture",i.default.VarChar,o);let d=await s.execute(this.schema+"[usp_get]");return d.recordset.length>0?d.recordset[0]:void 0}catch(s){throw s}}async getBase(r,t,o){try{let n=new i.default.Request(await m.get(f));n.input("id",i.default.Int,r),n.input("usercode",i.default.Int,t),n.input("culture",i.default.VarChar,o);let s=await n.execute(this.schema+"[usp_getBase]");return s.recordset.length>0?s.recordset[0]:void 0}catch(n){throw n}}async findItemNumById(r){try{let t=new i.default.Request(await m.get(f));t.input("id",i.default.Int,r);let o=await t.execute("findItemNumById");return o.recordset.length>0?o.recordset[0].itemNum:void 0}catch(t){throw t}}async putFavorite(r,t,o,n){try{let s=new i.default.Request(await m.get(f));s.input("product_id",i.default.Int,r),s.input("customer_id",i.default.Int,t),s.input("address_id",i.default.Int,o),s.input("mode",i.default.Bit,n);let d=await s.execute(this.schema+"[usp_putFavorite]");return d.rowsAffected.length>0?d.rowsAffected[0]>0:void 0}catch(s){throw s}}async getUserSettings(r){try{let t=new i.default.Request(await m.get(f));t.input("usercode",i.default.Int,r);let o=await t.execute("sso.usp_getUserSettings");return o.recordset.length>0?o.recordset[0]:void 0}catch(t){throw t}}};var _=async(e,r)=>{try{let t=new l,o=e.token||{sub:null},{id:n}=e.params,s=e.query.usercode,d=e.query.culture??"nl",u,a=await t.findItemNumById(n);g.default.configure({c:!1,tw:1e3,simpleParameters:!0});let w=await g.default.run("getProdInfo",["BRA",0,0,[{itemNum:a}],void 0]);w&&w.status===200&&(u=w.result);let c={product:await t.get(n,s,d,o.sub)};if(c.product===null){r.status(401).send({verified:!1,error:"Wrong credentials"});return}if(c.product.error){r.status(404).send({error:c.product.error});return}u&&c.product&&(c.product.stock=u!==void 0?u.stock:-1,c.product.availableOn=u!==void 0?u.availableOn:null,c.product.inBackorder=u!==void 0?u.inBackorder:!1);let q=u!==void 0?u.stock:-1;return e.log.info({productId:n,usercode:s,stock:q,culture:d},"Get product details"),c}catch(t){return r.status(500).send(t)}},I=async(e,r)=>{try{let t=new l,o=e.params.id,n=e.query.usercode,s=e.query.culture??"nl",d={product:await t.getBase(o,n,s)};if(d.product===null){r.status(401).send({verified:!1,error:"Wrong credentials"});return}return d}catch(t){return r.status(500).send(t)}},R=async(e,r)=>{try{let t=new l,o=e.params.id,n=e.query.usercode,s=e.query.mode,d=await t.getBase(o,n,"nl"),u=await t.getUserSettings(+e.query.usercode);if(d&&u){console.debug(u),g.default.configure({c:!1,tw:-1,simpleParameters:!0});let a=await g.default.run("putFavorite",["BRA",{favorites:[{usercode:n,customer_id:u.customer_id,address_id:u.address_id,itemnum:d.itemnum,unit_code:d.unit_code,mode:s}]},void 0]);return e.log.info({order_id:e.params.id,customer_id:u.customer_id,address_id:u.address_id,customer:u},"Put favorite"),console.debug(a),a&&a.status===200?(await t.putFavorite(o,u.customer_id,u.address_id,s),{statusCode:200,result:a.result}):r.code(a.status).send(a)}}catch(t){return r.status(500).send(t)}};var B=[{method:"GET",url:"/:id",handler:_,requiredPermissions:[]},{method:"GET",url:"/:id/base",handler:I,requiredPermissions:[]},{method:"PUT",url:"/:id/favorite",handler:R,requiredPermissions:[]}];var U=require("./config"),W=async()=>{let e=new F.default(U.wrapper);e.addAuthPreHandler(v.default,"token"),e.routeMultiple(B),await e.start()};W();
