var C=Object.create;var h=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var T=(e,r,t,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of k(r))!N.call(e,s)&&s!==t&&h(e,s,{get:()=>r[s],enumerable:!(o=x(r,s))||o.enumerable});return e};var y=(e,r,t)=>(t=e!=null?C(A(e)):{},T(r||!e||!e.__esModule?h(t,"default",{value:e,enumerable:!0}):t,e));var F=y(require("@groupclaes/fastify-elastic")),v=y(require("@groupclaes/fastify-authhandler"));var g=y(require("@groupclaes/oe-connector"));var u=y(require("mssql"));var P=require("mssql"),b=require("./config"),p=new Map,m={get:async e=>{if(!p.has(e)){if(!b.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let r=new P.ConnectionPool(b.mssql[e]),t=r.close.bind(r);r.close=(...o)=>(p.delete(e),t(...o)),p.set(e,await r.connect())}return p.get(e)},closeAll:()=>Promise.all(Array.from(p.values()).map(e=>e.then(r=>r.close())))};var f="brabopak",l=class{constructor(){this.schema="[product]."}async get(r,t,o,s){try{let n=new u.default.Request(await m.get(f));n.input("id",u.default.Int,r),n.input("user_id",u.default.VarChar,s),n.input("usercode",u.default.Int,t),n.input("culture",u.default.VarChar,o);let a=await n.execute(this.schema+"[usp_get]");return a.recordset.length>0?a.recordset[0]:void 0}catch(n){throw n}}async getBase(r,t,o){try{let s=new u.default.Request(await m.get(f));s.input("id",u.default.Int,r),s.input("usercode",u.default.Int,t),s.input("culture",u.default.VarChar,o);let n=await s.execute(this.schema+"[usp_getBase]");return n.recordset.length>0?n.recordset[0]:void 0}catch(s){throw s}}async findItemNumById(r){try{let t=new u.default.Request(await m.get(f));t.input("id",u.default.Int,r);let o=await t.execute("findItemNumById");return o.recordset.length>0?o.recordset[0].itemNum:void 0}catch(t){throw t}}async putFavorite(r,t,o,s){try{let n=new u.default.Request(await m.get(f));n.input("id",u.default.Int,r),n.input("customer_id",u.default.Int,t),n.input("address_id",u.default.Int,o),n.input("type",u.default.Bit,s);let a=await n.execute(this.schema+"[usp_putFavorite]");return a.rowsAffected.length>0?a.rowsAffected[0]>0:void 0}catch(n){throw n}}async getUserSettings(r){try{let t=new u.default.Request(await m.get(f));t.input("usercode",u.default.Int,r);let o=await t.execute("sso.usp_getUserSettings");return o.recordset.length>0?o.recordset[0]:void 0}catch(t){throw t}}};var _=async(e,r)=>{try{let t=new l,o=e.token||{sub:null},{id:s}=e.params,n=e.query.usercode,a=e.query.culture??"nl",i,d=await t.findItemNumById(s);g.default.configure({c:!1,tw:1e3,simpleParameters:!0});let w=await g.default.run("getProdInfo",["BRA",0,0,[{itemNum:d}],void 0]);w&&w.status===200&&(i=w.result);let c={product:await t.get(s,n,a,o.sub)};if(c.product===null){r.status(401).send({verified:!1,error:"Wrong credentials"});return}if(c.product.error){r.status(404).send({error:c.product.error});return}i&&c.product&&(c.product.stock=i!==void 0?i.stock:-1,c.product.availableOn=i!==void 0?i.availableOn:null,c.product.inBackorder=i!==void 0?i.inBackorder:!1);let q=i!==void 0?i.stock:-1;return e.log.info({productId:s,usercode:n,stock:q,culture:a},"Get product details"),c}catch(t){return r.status(500).send(t)}},I=async(e,r)=>{try{let t=new l,o=e.params.id,s=e.query.usercode,n=e.query.culture??"nl",a={product:await t.getBase(o,s,n)};if(a.product===null){r.status(401).send({verified:!1,error:"Wrong credentials"});return}return a}catch(t){return r.status(500).send(t)}},R=async(e,r)=>{try{let t=new l,o=e.params.id,s=e.query.usercode,n=e.query.mode,a=await t.getBase(o,s,"nl"),i=await t.getUserSettings(e.query.usercode);if(a){g.default.configure({c:!1,tw:-1,simpleParameters:!0});let d=await g.default.run("putFavorite",["BRA",{favorites:[{usercode:s,customer_id:i.id,address_id:i.address_id,itemnum:a.itemnum,unit_code:a.unit_code,mode:n}]},void 0]);return e.log.info({order_id:e.params.id,customer_id:i.customer_id,address_id:i.address_id,customer:i},"Put favorite"),console.debug(d),d&&d.status===200?(await t.putFavorite(o,i.id,i.address_id,n),{statusCode:200,result:d.result}):r.code(d.status).send(d)}}catch(t){return r.status(500).send(t)}};var B=[{method:"GET",url:"/:id",handler:_,requiredPermissions:[]},{method:"GET",url:"/:id/base",handler:I,requiredPermissions:[]},{method:"PUT",url:"/:id/favorite",handler:R,requiredPermissions:[]}];var U=require("./config"),W=async()=>{let e=new F.default(U.wrapper);e.addAuthPreHandler(v.default,"token"),e.routeMultiple(B),await e.start()};W();
