var v=Object.create;var h=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,D=Object.prototype.hasOwnProperty;var U=(e,r,t,u)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of A(r))!D.call(e,o)&&o!==t&&h(e,o,{get:()=>r[o],enumerable:!(u=C(r,o))||u.enumerable});return e};var y=(e,r,t)=>(t=e!=null?v(k(e)):{},U(r||!e||!e.__esModule?h(t,"default",{value:e,enumerable:!0}):t,e));var B=y(require("@groupclaes/fastify-elastic")),q=y(require("@groupclaes/fastify-authhandler"));var g=y(require("@groupclaes/oe-connector"));var n=y(require("mssql"));var _=require("mssql"),b=require("./config"),f=new Map,p={get:async e=>{if(!f.has(e)){if(!b.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let r=new _.ConnectionPool(b.mssql[e]),t=r.close.bind(r);r.close=(...u)=>(f.delete(e),t(...u)),f.set(e,await r.connect())}return f.get(e)},closeAll:()=>Promise.all(Array.from(f.values()).map(e=>e.then(r=>r.close())))};var m="brabopak",l=class{schema="[product].";async get(r,t,u,o){try{let s=new n.default.Request(await p.get(m));s.input("id",n.default.Int,r),s.input("user_id",n.default.VarChar,o),s.input("usercode",n.default.Int,t),s.input("culture",n.default.VarChar,u);let a=await s.execute(this.schema+"[usp_get]");return a.recordset.length>0?a.recordset[0]:void 0}catch(s){throw s}}async getBase(r,t,u){try{let o=new n.default.Request(await p.get(m));o.input("id",n.default.Int,r),o.input("usercode",n.default.Int,t),o.input("culture",n.default.VarChar,u);let s=await o.execute(this.schema+"[usp_getBase]");return s.recordset.length>0?s.recordset[0]:void 0}catch(o){throw o}}async findItemNumById(r){try{let t=new n.default.Request(await p.get(m));t.input("id",n.default.Int,r);let u=await t.execute("findItemNumById");return u.recordset.length>0?u.recordset[0].itemNum:void 0}catch(t){throw t}}async putFavorite(r,t,u,o){try{let s=new n.default.Request(await p.get(m));s.input("product_id",n.default.Int,r),s.input("customer_id",n.default.Int,t),s.input("address_id",n.default.Int,u),s.input("mode",n.default.Bit,o);let a=await s.execute(this.schema+"[usp_putFavorite]");return a.rowsAffected.length>0?a.rowsAffected[0]>0:void 0}catch(s){throw s}}async putDescription(r,t,u,o){try{let s=new n.default.Request(await p.get(m));s.input("product_id",n.default.Int,r),s.input("customer_id",n.default.Int,t),s.input("address_id",n.default.Int,u),s.input("description",n.default.VarChar,o);let a=await s.execute(this.schema+"[usp_putDescription]");return a.rowsAffected.length>0?a.rowsAffected[0]>0:void 0}catch(s){throw s}}async deleteDescription(r,t,u){try{let o=new n.default.Request(await p.get(m));o.input("product_id",n.default.Int,r),o.input("customer_id",n.default.Int,t),o.input("address_id",n.default.Int,u);let s=await o.execute(this.schema+"[usp_deleteDescription]");return s.rowsAffected.length>0?s.rowsAffected[0]>0:void 0}catch(o){throw o}}async getUserSettings(r){try{let t=new n.default.Request(await p.get(m));t.input("usercode",n.default.Int,r);let u=await t.execute("sso.usp_getUserSettings");return u.recordset.length>0?u.recordset[0]:void 0}catch(t){throw t}}};var P=async(e,r)=>{try{let t=new l,u=e.token||{sub:null},{id:o}=e.params,s=e.query.usercode,a=e.query.culture??"nl",i,c=await t.findItemNumById(o);g.default.configure({c:!1,tw:1e3,simpleParameters:!0});let w=await g.default.run("getProdInfo",["BRA",0,0,[{itemNum:c}],void 0]);w&&w.status===200&&(i=w.result);let d={product:await t.get(o,s,a,u.sub)};if(d.product===null)return r.status(401).send({status:"fail",code:401,message:"Unauthorized"});if(d.product.error){r.status(404).send({error:d.product.error});return}i&&d.product&&(d.product.stock=i!==void 0?i.stock:-1,d.product.available_on=i!==void 0?i.availableOn:null,d.product.in_backorder=i!==void 0?i.inBackorder:!1);let x=i!==void 0?i.stock:-1;return e.log.info({productId:o,usercode:s,stock:x,culture:a},"Get product details"),{status:"success",code:200,data:d}}catch{return r.status(500).send({status:"error",code:500,message:"failed to get product information"})}},I=async(e,r)=>{try{let t=new l,u=e.params.id,o=e.query.usercode,s=e.query.culture??"nl",a={product:await t.getBase(u,o,s)};return a.product===null?r.status(401).send({status:"fail",code:401,message:"Unauthorized"}):{status:"success",code:200,data:a}}catch{return r.status(500).send({status:"error",code:500,message:"failed to get base product information"})}},R=async(e,r)=>{try{let t=new l,u=e.params.id,o=+e.query.usercode,s=e.query.mode,a=await t.getBase(u,o,"nl"),i=await t.getUserSettings(o);if(a&&i){console.debug(i),g.default.configure({c:!1,tw:-1,simpleParameters:!0});let c=await g.default.run("putFavorite",["BRA",{favorites:[{usercode:o,customer_id:i.customer_id,address_id:i.address_id,itemnum:a.itemnum,unit_code:a.unit_code,mode:s}]},void 0]);return e.log.info({order_id:e.params.id,customer_id:i.customer_id,address_id:i.address_id,customer:i},"Put favorite"),console.debug(c),c&&c.status===200?(await t.putFavorite(u,i.customer_id,i.address_id,s),{status:"success",code:c.status,data:c.result}):{status:"fail",code:c.status,data:c.result}}}catch{return r.status(500).send({status:"error",code:500,message:"failed to update product favorite status"})}};var F=[{method:"GET",url:"/:id",handler:P,requiredPermissions:[]},{method:"GET",url:"/:id/base",handler:I,requiredPermissions:[]},{method:"PUT",url:"/:id/favorite",handler:R,requiredPermissions:[]}];var Q=require("./config"),S=async()=>{let e=new B.default(Q.wrapper);e.addAuthPreHandler(q.default,"token"),e.routeMultiple(F),await e.start()};S();
