var A=Object.create;var h=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var U=Object.getPrototypeOf,T=Object.prototype.hasOwnProperty;var E=(t,r,e,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of k(r))!T.call(t,s)&&s!==e&&h(t,s,{get:()=>r[s],enumerable:!(n=D(r,s))||n.enumerable});return t};var y=(t,r,e)=>(e=t!=null?A(U(t)):{},E(r||!t||!t.__esModule?h(e,"default",{value:t,enumerable:!0}):e,t));var x=y(require("@groupclaes/fastify-elastic")),v=y(require("@groupclaes/fastify-authhandler"));var g=y(require("@groupclaes/oe-connector"));var i=y(require("mssql"));var _=require("mssql"),b=require("./config"),f=new Map,m={get:async t=>{if(!f.has(t)){if(!b.mssql[t])throw new Error(`Configuration for pool '${t}' does not exist!`);let r=new _.ConnectionPool(b.mssql[t]),e=r.close.bind(r);r.close=(...n)=>(f.delete(t),e(...n)),f.set(t,await r.connect())}return f.get(t)},closeAll:()=>Promise.all(Array.from(f.values()).map(t=>t.then(r=>r.close())))};var l="brabopak",c=class{schema="[product].";async get(r,e,n,s){try{let o=new i.default.Request(await m.get(l));o.input("id",i.default.Int,r),o.input("user_id",i.default.VarChar,s),o.input("usercode",i.default.Int,e),o.input("culture",i.default.VarChar,n);let a=await o.execute(this.schema+"[usp_get]");return a.recordset.length>0?a.recordset[0]:void 0}catch(o){throw o}}async getBase(r,e,n){try{let s=new i.default.Request(await m.get(l));s.input("id",i.default.Int,r),s.input("usercode",i.default.Int,e),s.input("culture",i.default.VarChar,n);let o=await s.execute(this.schema+"[usp_getBase]");return o.recordset.length>0?o.recordset[0]:void 0}catch(s){throw s}}async findItemNumById(r){try{let e=new i.default.Request(await m.get(l));e.input("id",i.default.Int,r);let n=await e.execute("findItemNumById");return n.recordset.length>0?n.recordset[0].itemNum:void 0}catch(e){throw e}}async putFavorite(r,e,n,s){try{let o=new i.default.Request(await m.get(l));o.input("product_id",i.default.Int,r),o.input("customer_id",i.default.Int,e),o.input("address_id",i.default.Int,n),o.input("mode",i.default.Bit,s);let a=await o.execute(this.schema+"[usp_putFavorite]");return a.rowsAffected.length>0?a.rowsAffected[0]>0:void 0}catch(o){throw o}}async putDescription(r,e,n,s){try{let o=new i.default.Request(await m.get(l));o.input("product_id",i.default.Int,r),o.input("customer_id",i.default.Int,e),o.input("address_id",i.default.Int,n),o.input("description",i.default.VarChar,s);let a=await o.execute(this.schema+"[usp_putDescription]");return a.rowsAffected.length>0?a.rowsAffected[0]>0:void 0}catch(o){throw o}}async deleteDescription(r,e,n){try{let s=new i.default.Request(await m.get(l));s.input("product_id",i.default.Int,r),s.input("customer_id",i.default.Int,e),s.input("address_id",i.default.Int,n);let o=await s.execute(this.schema+"[usp_deleteDescription]");return o.rowsAffected.length>0?o.rowsAffected[0]>0:void 0}catch(s){throw s}}async getUserSettings(r){try{let e=new i.default.Request(await m.get(l));e.input("usercode",i.default.Int,r);let n=await e.execute("sso.usp_getUserSettings");return n.recordset.length>0?n.recordset[0]:void 0}catch(e){throw e}}};var P=async(t,r)=>{try{let e=new c,n=t.token||{sub:null},{id:s}=t.params,o=t.query.usercode,a=t.query.culture??"nl",u,d=await e.findItemNumById(s);g.default.configure({c:!1,tw:1e3,simpleParameters:!0});let w=await g.default.run("getProdInfo",["BRA",0,0,[{itemNum:d}],void 0]);w&&w.status===200&&(u=w.result);let p={product:await e.get(s,o,a,n.sub)};if(p.product===null)return r.status(401).send({status:"fail",code:401,message:"Unauthorized"});if(p.product.error){r.status(404).send({error:p.product.error});return}u&&p.product&&(p.product.stock=u!==void 0?u.stock:-1,p.product.available_on=u!==void 0?u.availableOn:null,p.product.in_backorder=u!==void 0?u.inBackorder:!1);let C=u!==void 0?u.stock:-1;return t.log.info({productId:s,usercode:o,stock:C,culture:a},"Get product details"),{status:"success",code:200,data:p}}catch{return r.status(500).send({status:"error",code:500,message:"failed to get product information"})}},I=async(t,r)=>{try{let e=new c,n=t.params.id,s=t.query.usercode,o=t.query.culture??"nl",a={product:await e.getBase(n,s,o)};return a.product===null?r.status(401).send({status:"fail",code:401,message:"Unauthorized"}):{status:"success",code:200,data:a}}catch{return r.status(500).send({status:"error",code:500,message:"failed to get base product information"})}},R=async(t,r)=>{try{let e=new c,n=t.params.id,s=+t.query.usercode,o=t.query.mode,a=await e.getBase(n,s,"nl"),u=await e.getUserSettings(s);if(a&&u){console.debug(u),g.default.configure({c:!1,tw:-1,simpleParameters:!0});let d=await g.default.run("putFavorite",["BRA",{favorites:[{usercode:s,customer_id:u.customer_id,address_id:u.address_id,itemnum:a.itemnum,unit_code:a.unit_code,mode:o}]},void 0]);return t.log.info({order_id:t.params.id,customer_id:u.customer_id,address_id:u.address_id,customer:u},"Put favorite"),console.debug(d),d&&d.status===200?(await e.putFavorite(n,u.customer_id,u.address_id,o),{status:"success",code:d.status,data:d.result}):{status:"fail",code:d.status,data:d.result}}}catch{return r.status(500).send({status:"error",code:500,message:"failed to update product favorite status"})}},F=async(t,r)=>{try{let e=new c,n=t.params.id,s=+t.query.usercode,o=await e.getBase(n,s,"nl"),a=await e.getUserSettings(s);if(o&&a){let u=await e.putDescription(n,a.customer_id,a.address_id,t.body.description);return u?{status:"success",code:200,data:{success:u}}:{status:"fail",code:404,message:"Failed to update database record",data:{success:u}}}return{status:"error",code:404,message:"product or customer not found"}}catch{return r.status(500).send({status:"error",code:500,message:"failed to update product description"})}},q=async(t,r)=>{try{let e=new c,n=t.params.id,s=+t.query.usercode,o=await e.getBase(n,s,"nl"),a=await e.getUserSettings(s);if(o&&a){let u=await e.deleteDescription(n,a.customer_id,a.address_id);return u?{status:"success",code:200,data:{success:u}}:{status:"fail",code:404,message:"Failed to remove database record",data:{success:u}}}return{status:"error",code:404,message:"product or customer not found"}}catch{return r.status(500).send({status:"error",code:500,message:"failed to remove product description"})}};var B=[{method:"GET",url:"/:id",handler:P,requiredPermissions:[]},{method:"GET",url:"/:id/base",handler:I,requiredPermissions:[]},{method:"PUT",url:"/:id/favorite",handler:R,requiredPermissions:[]},{method:"PUT",url:"/:id/description",handler:F,requiredPermissions:[]},{method:"DELTE",url:"/:id/description",handler:q,requiredPermissions:[]}];var Q=require("./config"),S=async()=>{let t=new x.default(Q.wrapper);t.addAuthPreHandler(v.default,"token"),t.routeMultiple(B),await t.start()};S();
