var x=Object.create;var h=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var A=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var U=(e,r,t,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of k(r))!N.call(e,o)&&o!==t&&h(e,o,{get:()=>r[o],enumerable:!(n=C(r,o))||n.enumerable});return e};var y=(e,r,t)=>(t=e!=null?x(A(e)):{},U(r||!e||!e.__esModule?h(t,"default",{value:e,enumerable:!0}):t,e));var F=y(require("@groupclaes/fastify-elastic")),q=y(require("@groupclaes/fastify-authhandler"));var g=y(require("@groupclaes/oe-connector"));var i=y(require("mssql"));var P=require("mssql"),b=require("./config"),p=new Map,m={get:async e=>{if(!p.has(e)){if(!b.mssql[e])throw new Error(`Configuration for pool '${e}' does not exist!`);let r=new P.ConnectionPool(b.mssql[e]),t=r.close.bind(r);r.close=(...n)=>(p.delete(e),t(...n)),p.set(e,await r.connect())}return p.get(e)},closeAll:()=>Promise.all(Array.from(p.values()).map(e=>e.then(r=>r.close())))};var f="brabopak",l=class{constructor(){this.schema="[product]."}async get(r,t,n,o){try{let s=new i.default.Request(await m.get(f));s.input("id",i.default.Int,r),s.input("user_id",i.default.VarChar,o),s.input("usercode",i.default.Int,t),s.input("culture",i.default.VarChar,n);let a=await s.execute(this.schema+"[usp_get]");return a.recordset.length>0?a.recordset[0]:void 0}catch(s){throw s}}async getBase(r,t,n){try{let o=new i.default.Request(await m.get(f));o.input("id",i.default.Int,r),o.input("usercode",i.default.Int,t),o.input("culture",i.default.VarChar,n);let s=await o.execute(this.schema+"[usp_getBase]");return s.recordset.length>0?s.recordset[0]:void 0}catch(o){throw o}}async findItemNumById(r){try{let t=new i.default.Request(await m.get(f));t.input("id",i.default.Int,r);let n=await t.execute("findItemNumById");return n.recordset.length>0?n.recordset[0].itemNum:void 0}catch(t){throw t}}async putFavorite(r,t,n,o){try{let s=new i.default.Request(await m.get(f));s.input("product_id",i.default.Int,r),s.input("customer_id",i.default.Int,t),s.input("address_id",i.default.Int,n),s.input("mode",i.default.Bit,o);let a=await s.execute(this.schema+"[usp_putFavorite]");return a.rowsAffected.length>0?a.rowsAffected[0]>0:void 0}catch(s){throw s}}async getUserSettings(r){try{let t=new i.default.Request(await m.get(f));t.input("usercode",i.default.Int,r);let n=await t.execute("sso.usp_getUserSettings");return n.recordset.length>0?n.recordset[0]:void 0}catch(t){throw t}}};var _=async(e,r)=>{try{let t=new l,n=e.token||{sub:null},{id:o}=e.params,s=e.query.usercode,a=e.query.culture??"nl",u,d=await t.findItemNumById(o);g.default.configure({c:!1,tw:1e3,simpleParameters:!0});let w=await g.default.run("getProdInfo",["BRA",0,0,[{itemNum:d}],void 0]);w&&w.status===200&&(u=w.result);let c={product:await t.get(o,s,a,n.sub)};if(c.product===null)return r.status(401).send({status:"fail",code:401,message:"Unauthorized"});if(c.product.error){r.status(404).send({error:c.product.error});return}u&&c.product&&(c.product.stock=u!==void 0?u.stock:-1,c.product.availableOn=u!==void 0?u.availableOn:null,c.product.inBackorder=u!==void 0?u.inBackorder:!1);let v=u!==void 0?u.stock:-1;return e.log.info({productId:o,usercode:s,stock:v,culture:a},"Get product details"),{status:"success",code:200,data:c}}catch{return r.status(500).send({status:"error",code:500,message:"failed to get product information"})}},I=async(e,r)=>{try{let t=new l,n=e.params.id,o=e.query.usercode,s=e.query.culture??"nl",a={product:await t.getBase(n,o,s)};return a.product===null?r.status(401).send({status:"fail",code:401,message:"Unauthorized"}):{status:"success",code:200,data:a}}catch{return r.status(500).send({status:"error",code:500,message:"failed to get base product information"})}},R=async(e,r)=>{try{let t=new l,n=e.params.id,o=e.query.usercode,s=e.query.mode,a=await t.getBase(n,o,"nl"),u=await t.getUserSettings(+e.query.usercode);if(a&&u){console.debug(u),g.default.configure({c:!1,tw:-1,simpleParameters:!0});let d=await g.default.run("putFavorite",["BRA",{favorites:[{usercode:o,customer_id:u.customer_id,address_id:u.address_id,itemnum:a.itemnum,unit_code:a.unit_code,mode:s}]},void 0]);return e.log.info({order_id:e.params.id,customer_id:u.customer_id,address_id:u.address_id,customer:u},"Put favorite"),console.debug(d),d&&d.status===200?(await t.putFavorite(n,u.customer_id,u.address_id,s),{status:"success",code:d.status,data:d.result}):{status:"fail",code:d.status,data:d.result}}}catch{return r.status(500).send({status:"error",code:500,message:"failed to update product favorite status"})}};var B=[{method:"GET",url:"/:id",handler:_,requiredPermissions:[]},{method:"GET",url:"/:id/base",handler:I,requiredPermissions:[]},{method:"PUT",url:"/:id/favorite",handler:R,requiredPermissions:[]}];var E=require("./config"),G=async()=>{let e=new F.default(E.wrapper);e.addAuthPreHandler(q.default,"token"),e.routeMultiple(B),await e.start()};G();
